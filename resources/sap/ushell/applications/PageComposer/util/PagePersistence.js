// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define([],function(){"use strict";var P=function(d,r){this._oODataModel=d;this._oResourceBundle=r;this._oEtags={};};P.prototype.getPages=function(){return this._readPages().then(function(p){for(var i=0;i<p.results.length;i++){this._storeETag(p.results[i]);}return p;}.bind(this)).then(this._convertODataToPageList).catch(this._rejectWithErrorMessage.bind(this));};P.prototype.getPage=function(p){return this._readPage(p).then(function(a){this._storeETag(a);return a;}.bind(this)).then(this._convertODataToReferencePage).catch(this._rejectWithErrorMessage.bind(this));};P.prototype.createPage=function(p){var a=this._convertReferencePageToOData(p);return this._createPage(a).then(this._storeETag.bind(this));};P.prototype.updatePage=function(u){var U=this._convertReferencePageToOData(u);U.modifiedOn=this._oEtags[u.content.id].modifiedOn;return this._createPage(U).then(this._storeETag.bind(this)).catch(this._rejectWithErrorMessage.bind(this));};P.prototype.deletePage=function(p,t){return new Promise(function(r,a){this._oODataModel.callFunction("/deletePage",{method:"POST",urlParameters:{pageId:p,transportId:t,modifiedOn:this._oEtags[p].modifiedOn},success:r,error:a});}.bind(this));};P.prototype.copyPage=function(p){return new Promise(function(r,a){this._oODataModel.callFunction("/copyPage",{method:"POST",urlParameters:{targetId:p.content.targetId.toUpperCase(),sourceId:p.content.sourceId,title:p.content.title,devclass:p.metadata.devclass,transportId:p.metadata.transportId},success:r,error:a});}.bind(this));};P.prototype.getCatalogs=function(p,r){return r?this._getCatalogsByRole(r):this._getCatalogsByPage(p);};P.prototype._readPages=function(){return new Promise(function(r,a){this._oODataModel.read("/pageSet",{success:r,error:a});}.bind(this));};P.prototype._readPage=function(p){return new Promise(function(r,a){this._oODataModel.read("/pageSet('"+encodeURIComponent(p)+"')",{urlParameters:{"$expand":"sections/tiles"},success:r,error:a});}.bind(this));};P.prototype._createPage=function(n){return new Promise(function(r,a){this._oODataModel.create("/pageSet",n,{success:r,error:a});}.bind(this));};P.prototype._convertODataToPageList=function(p){return p.results.map(function(o){return{content:{id:o.id,title:o.title,description:o.description,createdBy:o.createdBy,createdByFullname:o.createdByFullname,createdOn:o.createdOn,modifiedBy:o.modifiedBy,modifiedByFullname:o.modifiedByFullname,modifiedOn:o.modifiedOn,masterLanguage:o.masterLanguage},metadata:{devclass:o.devclass,transportId:o.transportId}};});};P.prototype._convertODataToReferencePage=function(p){return{content:{id:p.id,title:p.title,description:p.description,createdBy:p.createdBy,createdByFullname:p.createdByFullname,createdOn:p.createdOn,modifiedBy:p.modifiedBy,modifiedByFullname:p.modifiedByFullname,modifiedOn:p.modifiedOn,masterLanguage:p.masterLanguage,sections:p.sections.results.map(function(s){return{id:s.id,title:s.title,visualizations:s.tiles.results.map(function(t){return{id:t.id,vizId:t.catalogTile,inboundPermanentKey:t.targetMapping,title:t.title,subTitle:t.subTitle,iconUrl:t.iconUrl,tileType:t.tileType};})};})},metadata:{transportId:p.transportId,devclass:p.devclass}};};P.prototype._convertReferencePageToOData=function(p){var r=p.content,m=p.metadata;var o={id:r.id,title:r.title,description:r.description,devclass:m.devclass,transportId:m.transportId,sections:(r.sections||[]).map(function(s){return{id:s.id,title:s.title,tiles:(s.visualizations||[]).map(function(t){return{id:t.id,catalogTile:t.vizId,targetMapping:t.inboundPermanentKey};})};})};return o;};P.prototype._storeETag=function(p){this._oEtags[p.id]={modifiedOn:p.modifiedOn,etag:p.__metadata.etag};};P.prototype.abortPendingBackendRequests=function(){if(this._oODataModel.hasPendingRequests()){for(var i=0;i<this._oODataModel.aPendingRequestHandles.length;i++){this._oODataModel.aPendingRequestHandles[i].abort();}}};P.prototype._rejectWithErrorMessage=function(e){var E;if(e.statusCode==="412"){E=this._oResourceBundle.getText("Message.PageIsOutdated");}else{try{E=JSON.parse(e.responseText).error.message.value||e.message;}catch(a){E=e.message;}}return Promise.reject(E);};P.prototype._getCatalogsByRole=function(r){return new Promise(function(a,b){this._oODataModel.read("/roleSet('"+encodeURIComponent(r)+"')",{urlParameters:{"$expand":"catalogs/visualizations"},success:function(R){a(R.catalogs.results);},error:b});}.bind(this));};P.prototype._getCatalogsByPage=function(p){return new Promise(function(r,a){this._oODataModel.read("/pageSet('"+encodeURIComponent(p)+"')",{urlParameters:{"$expand":"roles/catalogs/visualizations"},success:function(o){var R=o.roles.results;var c=R.reduce(function(b,d){return b.concat(d.catalogs.results);},[]);r(c);},error:a});}.bind(this));};return P;},true);
