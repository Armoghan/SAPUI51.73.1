// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/ui/model/json/JSONModel","sap/ushell/Config"],function(m,J,C){"use strict";var L=m.LoadState;var M,p,r={};var v=new J({sizeBehavior:C.last("/core/home/sizeBehavior")});var _=C.on("/core/home/sizeBehavior").do(function(s){v.setProperty("/sizeBehavior",s);});function a(V){var P=V.getBindingContext().getPath().split("/"),i=P.pop();P.pop();return{visualizationIndex:i,sectionIndex:P.pop()};}function b(V){var o=V.getBindingContext(),i=o.getProperty(o.getPath()).inboundPermanentKey,t=V.getTarget();return i||!t||t[0]!=="#";}function c(o){var R={tileType:"sap.ushell.ui.tile.StaticTile",properties:{chipId:"",title:o.title,subtitle:o.subTitle,info:"",icon:o.iconUrl,targetURL:""}};switch(o.tileType){case"STATIC":return R;case"DYNAMIC":R.tileType="sap.ushell.ui.tile.DynamicTile";R.properties.icon="";return R;default:R.properties.info="["+r.i18n.getText("Title.CustomTile")+"]";R.properties.icon="";return R;}}return{init:function(o){M=o;p=o.getView().byId("page");p.setModel(o.getModel());p.setModel(v,"viewSettings");r.i18n=o.getResourceBundle();var e=o.getModel().getProperty("/edit");p.toggleStyleClass("sapUshellPageComposing",!!e);},exit:function(){_.off();},visualizationFactory:function(i,o){if(!M.oVisualizationLoadingService){throw new Error("Visualization Service was not loaded yet!");}var d=o.getProperty(o.sPath),V=d.vizId,t=c(d),e=M.oVisualizationLoadingService.instantiateVisualization({vizId:V,previewMode:true,directLoad:true,tileType:t.tileType,properties:t.properties});e._getInnerControlPromise().then(function(){var I=e.getInnerControl().getContent?e.getInnerControl().getContent()[0]:e.getInnerControl();I.attachPress(function(E){if(E.getParameter("action")==="Remove"){var f=a(e);M.deleteVisualizationInSection(f.visualizationIndex,f.sectionIndex);}});I.bindProperty("sizeBehavior","viewSettings>/sizeBehavior");I.setScope(M.getModel().getProperty("/edit")?"Actions":"Display");if(e.getState()!==L.Loading&&!b(e)&&I.setState){I.setState(L.Failed);}});return e;},collectMessages:function(){var e=[],w=[];p.getSections().forEach(function(s,S){var o=s.byId("title-edit");if(s.getTitle()===""){o.setValueState("Warning");o.setValueStateText(r.i18n.getText("Message.InvalidSectionTitle"));w.push({type:"Warning",title:r.i18n.getText("Title.NoSectionTitle",S+1),description:r.i18n.getText("Message.NoSectionTitle",S+1)});}else{o.setValueState("None");}s.getVisualizations().forEach(function(V,i){if(V.getState()===L.Failed){e.push({type:"Error",title:r.i18n.getText("Title.UnsufficientRoles"),subtitle:r.i18n.getText("Title.VisualizationIsNotVisible"),description:r.i18n.getText("Message.LoadTileError",[(i+1)+".",s.getTitle()])});}else if(V.getState()!==L.Loading&&!b(V)){w.push({type:"Warning",title:r.i18n.getText("Message.NavigationTargetError"),subtitle:r.i18n.getText("Title.VisualizationNotNavigateable"),description:r.i18n.getText("Message.NavTargetResolutionError",V.getTitle()||V.getCatalogTile().getTitle())});}});});return{errors:e,warnings:w};},addSection:function(e){var s=e?e.getParameter("index"):0;M.addSectionAt(s);},deleteSection:function(e){var s=e.getSource(),t=s.getTitle(),d=t?r.i18n.getText("Message.Section.Delete",t):r.i18n.getText("Message.Section.DeleteNoTitle");sap.ui.require(["sap/m/MessageBox"],function(f){function g(A){if(A===f.Action.DELETE){M.deleteSection(p.indexOfSection(s));}}sap.ushell.Container.getService("Message").confirm(d,g,r.i18n.getText("Button.Delete"),[f.Action.DELETE,f.Action.CANCEL]);});},moveSection:function(i){var d=i.getParameter("draggedControl"),D=i.getParameter("droppedControl"),I=i.getParameter("dropPosition"),e=p.indexOfSection(d),f=p.indexOfSection(D);if(I==="After"){if(f<e){f++;}}else if(f>e){f--;}M.moveSection(e,f);},moveVisualization:function(d){var D=d.getParameter("draggedControl"),o=d.getParameter("droppedControl"),i=d.getParameter("dropPosition");if(o.isA("sap.ushell.ui.launchpad.Section")){var e=a(D),s=p.indexOfSection(o),B=D.getBindingContext();M.addVisualisationToSection(B.getModel().getProperty(B.getPath()),[s],0);M.deleteVisualizationInSection(e.visualizationIndex,e.sectionIndex);return;}var f=a(o),g=f.visualizationIndex,h=f.sectionIndex;if(D.isA("sap.m.CustomTreeItem")){var j=d.getParameter("dragSession").getComplexData("callback");if(i==="After"){g++;}j(g,h);return;}var k=a(D),l=k.visualizationIndex,n=k.sectionIndex;if(n===h){if(i==="After"){if(g<l){g++;}}else if(g>l){g--;}}else if(i==="After"){g++;}M.moveVisualizationInSection(l,g,n,h);},addVisualization:function(d){var D=d.getParameter("draggedControl"),o=d.getParameter("droppedControl"),i=o.getVisualizations().length,e=p.indexOfSection(o);if(D.isA("sap.m.CustomTreeItem")){d.getParameter("dragSession").getComplexData("callback")(i,e);return;}var f=a(D),g=f.visualizationIndex,h=f.sectionIndex;M.moveVisualizationInSection(g,i,h,e);}};});
