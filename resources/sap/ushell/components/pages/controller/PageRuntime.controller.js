//Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/GenericTile","sap/ushell/resources","sap/m/MessagePage","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/ushell/components/pages/formatter/PageRuntimeFormatter","sap/m/library","sap/m/MessageToast"],function(C,G,r,M,J,a,P,l,b){"use strict";return C.extend("sap.ushell.components.pages.controller.Pages",{formatter:P,onInit:function(){this._oVisualizationLoadingService=sap.ushell.Container.getServiceAsync("VisualizationLoading");this._oPagesService=sap.ushell.Container.getServiceAsync("Pages");this._oURLParsingService=sap.ushell.Container.getServiceAsync("URLParsing");this._oViewSettingsModel=new J({sizeBehavior:a.last("/core/home/sizeBehavior")});this.getView().setModel(this._oViewSettingsModel,"viewSettings");this._aConfigListeners=a.on("/core/home/sizeBehavior").do(function(s){this._oViewSettingsModel.setProperty("/sizeBehavior",s);}.bind(this));this._oErrorPageModel=new J({icon:"sap-icon://documents",text:"",description:"",details:""});this.getView().setModel(this._oErrorPageModel,"errorPage");this._oPagesService.then(function(p){this.getView().setModel(p.getModel());}.bind(this));this.sCurrentTargetPageId="";this._openFLPPage();this.oContainerRouter=sap.ushell.Container.getRenderer().getRouter();this.oContainerRouter.getRoute("home").attachMatched(this._openFLPPage,this);this.oContainerRouter.getRoute("openFLPPage").attachMatched(this._openFLPPage,this);this.oEventBus=sap.ui.getCore().getEventBus();this.oEventBus.subscribe("sap.ushell","navigated",this._onShellNavigated,this);this.oErrorPage=this.byId("errorPage");this.oPagesNavContainer=this.byId("pagesNavContainer");this.oPagesNavContainer.attachNavigate(this._onPageNavigated,this);this.oPagesRuntimeNavContainer=this.byId("pagesRuntimeNavContainer");this.oPagesRuntimeNavContainer.attachNavigate(this._onErrorPageNavigated,this);document.addEventListener("visibilitychange",this._onTabNavigated.bind(this));},_onShellNavigated:function(){return this._oURLParsingService.then(function(u){var h=u.parseShellHash(window.hasher.getHash());if((h.semanticObject==="Shell"&&h.action==="home")||(h.semanticObject==="Launchpad"&&h.action==="openFLPPage")){this._setCurrentPageVisibility(true,true);}else{this._setCurrentPageVisibility(false,false);}}.bind(this));},_onTabNavigated:function(){return this._oURLParsingService.then(function(u){var h=u.parseShellHash(window.hasher.getHash());if((h.semanticObject==="Shell"&&h.action==="home")||(h.semanticObject==="Launchpad"&&h.action==="openFLPPage")){this._setCurrentPageVisibility(!document.hidden);}}.bind(this));},_onPageNavigated:function(e){var p=e.getParameters();var s=p.from;var t=p.to;this._setPageVisibility(s,false);this._setPageVisibility(t,true);},_onErrorPageNavigated:function(e){var t=e.getParameter("to");this._setCurrentPageVisibility(!(t instanceof M));},_setCurrentPageVisibility:function(v,c){var o=this.oPagesNavContainer.getCurrentPage();this._setPageVisibility(o,v,c);},_setPageVisibility:function(p,v,c){if(!p){return;}p.getContent()[0].getAggregation("sections").forEach(function(s){s.getAggregation("visualizations").forEach(function(V){if(V.setActive){V.setActive(v,c);}});});},_getPageAndSpaceId:function(){return this._oURLParsingService.then(function(u){var h=u.parseShellHash(window.hasher.getHash());var i={semanticObject:h.semanticObject||"",action:h.action||""};var H=h.params||{};var p=H.pageId||[];var s=H.spaceId||[];return this._parsePageAndSpaceId(p,s,i);}.bind(this));},_parsePageAndSpaceId:function(p,s,i){if(p.length<1&&s.length<1){if(i.semanticObject==="Shell"&&i.action==="home"){return this._getAssignedPage();}return Promise.reject(r.i18n.getText("PageRuntime.NoPageIdAndSpaceIdProvided"));}if(p.length===1&&s.length===0){return Promise.reject(r.i18n.getText("PageRuntime.OnlyPageIdProvided"));}if(p.length===0&&s.length===1){return Promise.reject(r.i18n.getText("PageRuntime.OnlySpaceIdProvided"));}if(p.length>1||s.length>1){return Promise.reject(r.i18n.getText("PageRuntime.MultiplePageOrSpaceIdProvided"));}if(p[0]===""){return Promise.reject(r.i18n.getText("PageRuntime.InvalidPageId"));}if(s[0]===""){return Promise.reject(r.i18n.getText("PageRuntime.InvalidSpaceId"));}return Promise.resolve({pageId:p[0],spaceId:s[0]});},_getAssignedPage:function(){return sap.ushell.Container.getServiceAsync("Menu").then(function(m){return m.getMenuEntries();}).then(function(m){if(m.length<1){return Promise.reject(r.i18n.getText("PageRuntime.NoAssignedPage"));}return this._oURLParsingService.then(function(u){var p;p=u.parseShellHash(m[0].intent).params;if(!p||!p.spaceId||!p.pageId){return Promise.reject(r.i18n.getText("PageRuntime.CannotFindADefaultPage"));}return{spaceId:p.spaceId[0],pageId:p.pageId[0]};});}.bind(this));},_openFLPPage:function(){var p,s;return this._getPageAndSpaceId().then(function(i){p=i.pageId;s=i.spaceId;this.sCurrentTargetPageId=p;return this._oVisualizationLoadingService.then(function(v){this._oResolvedVisualizationLoadingService=v;return Promise.all([v.loadVisualizationData(),this._oPagesService]);}.bind(this)).then(function(c){var o=c[1];return o.loadPage(p);}).then(function(){if(this.sCurrentTargetPageId===p){this._navigate(p);}}.bind(this)).catch(function(e){var d=r.i18n.getText("PageRuntime.CannotLoadPage.Description")+JSON.stringify(e);this._oErrorPageModel.setProperty("/icon","sap-icon://documents");this._oErrorPageModel.setProperty("/text",r.i18n.getText("PageRuntime.CannotLoadPage.Text",[p,s]));this._oErrorPageModel.setProperty("/description","");this._oErrorPageModel.setProperty("/details",d);this.oPagesRuntimeNavContainer.to(this.oErrorPage);}.bind(this));}.bind(this)).catch(function(e){this._oErrorPageModel.setProperty("/icon","sap-icon://documents");this._oErrorPageModel.setProperty("/text",e||"");this._oErrorPageModel.setProperty("/description","");this._oErrorPageModel.setProperty("/details","");this.oPagesRuntimeNavContainer.to(this.oErrorPage);}.bind(this));},_navigate:function(t){var p=this.oPagesNavContainer.getPages();var s;for(var i=0;i<p.length;i++){s=p[i].data("pageId");if(t&&t===s){this.oPagesNavContainer.to(p[i]);this.oPagesRuntimeNavContainer.to(this.oPagesNavContainer);return;}}},_pressViewDetailsButton:function(){var e=this._oErrorPageModel.getProperty("/details")||"";this._oErrorPageModel.setProperty("/description",e);},_copyToClipboard:function(){var t=document.createElement("textarea");try{t.contentEditable=true;t.readonly=false;t.textContent=this._oErrorPageModel.getProperty("/description");document.documentElement.appendChild(t);t.select();document.execCommand("copy");b.show(r.i18n.getText("PageRuntime.CannotLoadPage.CopySuccess"),{closeOnBrowserNavigation:false});}catch(e){b.show(r.i18n.getText("PageRuntime.CannotLoadPage.CopyFail"),{closeOnBrowserNavigation:false});}finally{t.parentNode.removeChild(t);}},_visualizationFactory:function(i,c){if(this._oResolvedVisualizationLoadingService){var v=c.getObject();return this._oResolvedVisualizationLoadingService.instantiateVisualization(v);}return new G({state:l.LoadState.Failed});},onExit:function(){this.oContainerRouter.getRoute("home").detachMatched(this._openFLPPage,this);this.oContainerRouter.getRoute("openFLPPage").detachMatched(this._openFLPPage,this);this._aConfigListeners.off();this.oEventBus.unsubscribe("sap.ushell","navigated",this._onPageNavigated,this);document.removeEventListener("visibilitychange");this.oPagesNavContainer.detachNavigate(this._onPageNavigated,this);this.oPagesRuntimeNavContainer.detachNavigate(this._onErrorPageNavigated,this);}});});
