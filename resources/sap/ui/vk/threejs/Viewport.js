/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../Core","../ViewportBase","sap/ui/core/ResizeHandler","sap/ui/events/KeyCodes","../Loco","./thirdparty/three","../ContentConnector","../ViewStateManager","./ViewportGestureHandler","./OrthographicCamera","./PerspectiveCamera","./NodesTransitionHelper","../Messages","sap/ui/base/ManagedObjectObserver","./ViewportRenderer","../CameraProjectionType","../CameraFOVBindingType","../VisibilityMode","../ZoomTo","../SelectionMode","../RenderMode","../getResourceBundle","../cssColorToColor","../ViewStateManager","./ViewStateManager","./Scene","./ContentDeliveryService"],function(q,v,V,R,K,L,c,C,d,e,O,P,N,M,f,g,j,k,l,Z,S,m,n,o,p,T,r,s){"use strict";var u=V.extend("sap.ui.vk.threejs.Viewport",{metadata:{library:"sap.ui.vk",events:{cameraChanged:{parameters:{position:"float[]",quaternion:"float[]",zoom:"float"},enableEventBubbling:true},frameRenderingFinished:{}}}});var z=u.getMetadata().getParent().getClass().prototype;THREE.PropertyBinding.prototype.GetterByBindingType[0]=function(b,a){b[a]=this.targetObject[this.propertyName];};u.prototype.init=function(){if(z.init){z.init.call(this);}this._resizeListenerId=null;this._renderLoopRequestId=0;this._renderLoopFunction=this._renderLoop.bind(this);this._shouldRenderFrame=true;this._clippingPlanes=[];this._renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(1,1);this._renderer.shadowMap.enabled=true;this._camera=new P();var b=new THREE.Vector4();var a=new THREE.Vector4();this._updateColor(b,this.getBackgroundColorTop());this._updateColor(a,this.getBackgroundColorBottom());this._checkBackgroundColor();this._backgroundMaterial=new THREE.ShaderMaterial({uniforms:{topColor:{value:b},bottomColor:{value:a}},vertexShader:["varying float vPos;","void main() {","	gl_Position = vec4(position, 1.0);","	vPos = position.y * -0.5 + 0.5;","}"].join("\n"),fragmentShader:["uniform vec4 topColor;","uniform vec4 bottomColor;","varying float vPos;","void main() {","	gl_FragColor = mix(topColor, bottomColor, vPos);","}"].join("\n"),side:THREE.DoubleSide,depthTest:false,depthWrite:false,blending:THREE.NoBlending});var h=new THREE.Geometry();h.vertices.push(new THREE.Vector3(-1,1,0),new THREE.Vector3(1,1,0),new THREE.Vector3(-1,-1,0),new THREE.Vector3(1,-1,0));h.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3));this._backgroundCamera=new THREE.Camera();this._backgroundScene=new THREE.Scene();this._backgroundScene.add(new THREE.Mesh(h,this._backgroundMaterial));this._xrayColor1=new THREE.Vector4(0,0.75,1,0.45);this._xrayColor2=new THREE.Vector4(0,0,1,0);this._xrayMaterial=new THREE.ShaderMaterial({uniforms:{color1:{value:this._xrayColor1},color2:{value:this._xrayColor2}},vertexShader:["#include <clipping_planes_pars_vertex>","varying vec3 vNormal;","void main() {","#include <begin_vertex>","#include <project_vertex>","#include <clipping_planes_vertex>","#include <beginnormal_vertex>","#include <defaultnormal_vertex>","	vNormal = normalize( transformedNormal );","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","uniform vec4 color1;","uniform vec4 color2;","varying vec3 vNormal;","void main() {","#include <clipping_planes_fragment>","	gl_FragColor = mix(color1, color2, abs(normalize(vNormal).z));","}"].join("\n"),side:THREE.DoubleSide,depthWrite:false,depthFunc:THREE.LessDepth,blending:THREE.NormalBlending,clipping:true,transparent:true});this._viewportGestureHandler=new e(this);this._loco=new L(this);this._loco.addHandler(this._viewportGestureHandler,-1);this._zoomedObject=null;this._cdsLoader=null;this.attachCameraChanged(function(i){this.setShouldRenderFrame();});this._sceneObserver=new f(this.setShouldRenderFrame.bind(this));this._currentViewIndex=0;this._currentView=null;this._playingProcedure=false;v.getEventBus().subscribe("sap.ui.vk","viewStateApplied",this._onViewApplied,this);};u.prototype.cameraUpdateCompleted=function(a){var b=this._getViewStateManagerThreeJS();if(b){b.fireReadyForAnimation({view:this._currentView,ignoreAnimationPosition:this._ignoreAnimationPosition});v.getEventBus().publish("sap.ui.vk","readyForAnimation",{source:b,view:this._currentView,ignoreAnimationPosition:this._ignoreAnimationPosition});}this.fireViewFinished({viewIndex:this._currentViewIndex});};u.prototype.exit=function(){v.getEventBus().unsubscribe("sap.ui.vk","viewStateApplied",this._onViewApplied,this);this._loco.removeHandler(this._viewportGestureHandler);this._viewportGestureHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();this.setScene(null);this.setCamera(null);this._renderer=null;this._backgroundCamera=null;this._backgroundMaterial=null;this._backgroundScene=null;this._loco=null;this._viewportGestureHandler=null;if(this._cdsLoader){this._cdsLoader.detachSceneUpdated(this._handleCdsSceneUpdate,this);}if(z.exit){z.exit.call(this);}};u.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);}return this;};u.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0;}return this;};u.prototype.setBackgroundColorTop=function(a){z.setBackgroundColorTop.call(this,a);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.topColor.value,a);this._checkBackgroundColor();}return this;};u.prototype.setBackgroundColorBottom=function(a){z.setBackgroundColorBottom.call(this,a);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.bottomColor.value,a);this._checkBackgroundColor();}return this;};u.prototype.setClippingPlanes=function(a){this._clippingPlanes=a;return this;};u.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();};u.prototype.onAfterRendering=function(){var a=this.getDomRef();a.appendChild(this._renderer.domElement);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:a.clientWidth,height:a.clientHeight}});this._startRenderLoop();};u.prototype._handleResize=function(a){if(!this._camera||!this._renderer){return false;}var w=a.size.width;var h=a.size.height;if(this._camera){this._camera.update(w,h);}this._renderer.setSize(w,h);this.fireResize({size:{width:w,height:h}});this.setShouldRenderFrame();return true;};u.prototype.setScene=function(a){this._scene=a;this._homeCamera=null;this._sceneObserver.disconnect();var b=this._getNativeScene();if(b){this._sceneObserver.observe(this._scene,{properties:["doubleSided"]});var h;for(var i=0;i<b.children.length;i++){h=b.children[i];if(h.private&&h.name==="DefaultLights"&&h.children.length){if(h.children[0]instanceof THREE.PointLight){this._eyePointLight=h.children[0];}}}}this.setShouldRenderFrame();return this;};u.prototype.getScene=function(){return this._scene;};u.prototype._getNativeScene=function(){return this._scene?this._scene.getSceneRef():null;};u.prototype._getNativeCamera=function(){return this._camera?this._camera.getCameraRef():null;};u.prototype.setCamera=function(a){if(z.setCamera){z.setCamera.call(this,a);}var b=this.getCamera();if(b&&this._renderer){var h=this._renderer.getSize();b.update(h.width,h.height);if(!this._homeCamera&&b.getCameraRef()){this._homeCamera=b.getCameraRef().clone();}}this.setShouldRenderFrame();return this;};u.prototype.getRenderer=function(){return this._renderer;};u.prototype._getViewStateManagerThreeJS=function(){if(this._viewStateManager){if(this._viewStateManager instanceof T){return this._viewStateManager;}if(this._viewStateManager instanceof p&&this._viewStateManager._implementation instanceof T){return this._viewStateManager._implementation;}}return null;};u.prototype._getLayers=function(){var a=this._getViewStateManagerThreeJS();return a?a._layers:null;};u.prototype._updateBoundingBoxesIfNeeded=function(){var a=this._getViewStateManagerThreeJS();if(a){a._updateBoundingBoxesIfNeeded();}};u.prototype._updateColor=function(a,b){var h=o(b);a.color=new THREE.Color(h.red/255,h.green/255,h.blue/255);a.alpha=h.alpha;a.x=a.color.r*a.alpha;a.y=a.color.g*a.alpha;a.z=a.color.b*a.alpha;a.w=a.alpha;};u.prototype._checkBackgroundColor=function(){var a=this.getBackgroundColorTop();if(a===this.getBackgroundColorBottom()){if(this._backgroundColor===null){this._backgroundColor=new THREE.Vector4();}this._updateColor(this._backgroundColor,a);}else{this._backgroundColor=null;}this.setShouldRenderFrame();};u.prototype._handleCdsSceneUpdate=function(){this.setShouldRenderFrame();};u.prototype.setShouldRenderFrame=function(){this._shouldRenderFrame=true;return this;};u.prototype.shouldRenderFrame=function(){return this._shouldRenderFrame;};u.prototype.setRenderMode=function(a){this.setProperty("renderMode",a,true);if(this._scene){switch(a){case m.LineIllustration:case m.ShadedIllustration:case m.SolidOutline:this._scene._createOutlineGeometry(a);break;default:this._scene._hideOutlineGeometry();break;}}this.setShouldRenderFrame();return this;};u.prototype.hitTest=function(x,y){var a=this._getNativeScene();var b=this._getNativeCamera();if(!b||!a){return null;}var h=this._renderer.domElement;var w=new THREE.Vector2((x-h.clientLeft)/h.clientWidth*2-1,(h.clientTop-y)/h.clientHeight*2+1);var G=new THREE.Raycaster();var H=this._getLayers();G.setFromCamera(w,b);if(this._clippingPlanes){for(var I in this._clippingPlanes){var J=this._clippingPlanes[I];var Q=J.distanceToPoint(G.ray.origin),t=-Q/J.normal.dot(G.ray.direction);if(t>0){if(Q<0){G.near=Math.max(G.near,t);}else{G.far=Math.min(G.far,t);}}else if(Q<0){return null;}}}var U=G.intersectObjects(a.children,true);if(U){for(var i in U){var W=U[i];var X=W.object;var Y=X.parent;while(Y){if(Y.userData.closed){X=Y;}Y=Y.parent;}while(X.parent&&(X.userData.skipIt||(X.layers===X.parent.layers))){X=X.parent;}if(X.layers.test(H)&&!X.isBillboard&&!X.isDetailView){W.object=X;return W;}}}return null;};u.prototype.tap=function(x,y,i){if(!i){if(this._viewStateManager){var h=this.hitTest(x,y);var a=h&&h.object;var b={picked:a?[a]:[]};this.fireNodesPicked(b);if(this.getSelectionMode()===S.Exclusive){this.exclusiveSelectionHandler(b.picked);}else if(this.getSelectionMode()===S.Sticky){this.stickySelectionHandler(b.picked);}if(a!==null){this.fireNodeClicked({nodeRef:a,x:x,y:y},true,true);}}}else if(!this.getFreezeCamera()){var t=this.hitTest(x,y);if(t&&(this._zoomedObject===null||this._zoomedObject!==t.object)){this._zoomedObject=t.object;this._viewportGestureHandler.zoomObject(this._zoomedObject,true);}else{this._viewportGestureHandler.zoomObject(this._zoomedObject,false);this._zoomedObject=null;}}return this;};var A={x:-2,y:-2};var B=2;var D=5;u.prototype.onkeydown=function(a){if(!a.isMarked()){var b;switch(a.keyCode){case K.ARROW_LEFT:case K.ARROW_RIGHT:case K.ARROW_UP:case K.ARROW_DOWN:if(a.ctrlKey||a.altKey||a.metaKey){break;}var h={x:0,y:0};switch(a.keyCode){case K.ARROW_LEFT:h.x=-1;break;case K.ARROW_RIGHT:h.x=+1;break;case K.ARROW_UP:h.y=-1;break;case K.ARROW_DOWN:h.y=+1;break;default:break;}b=this._viewportGestureHandler._cameraController;b.beginGesture(A.x,A.y);if(a.shiftKey){b.pan(D*h.x,D*h.y);}else{b.rotate(B*h.x,B*h.y,true);}b.endGesture();this.setShouldRenderFrame();a.preventDefault();a.stopPropagation();break;case 189:case K.PLUS:case K.NUMPAD_MINUS:case K.NUMPAD_PLUS:b=this._viewportGestureHandler._cameraController;b.beginGesture(this.$().width()/2,this.$().height()/2);b.zoom(a.keyCode===K.PLUS||a.keyCode===K.NUMPAD_PLUS?1.02:0.98);b.endGesture();this.setShouldRenderFrame();a.preventDefault();a.stopPropagation();break;default:break;}}};u.prototype._handleVisibilityChanged=u.prototype._handleOpacityChanged=u.prototype._handleTintColorChanged=u.prototype._handleHighlightColorChanged=u.prototype._handleTransformationChanged=u.prototype._handleOutlineColorChanged=u.prototype._handleOutlineWidthChanged=u.prototype._handleOutliningChanged=function(a){this.setShouldRenderFrame();};u.prototype._handleSelectionChanged=function(a){var t=this.getTools();for(var i=0;i<t.length;i++){var b=sap.ui.getCore().byId(t[i]);var h=b.getGizmoForContainer(this);if(h&&h.handleSelectionChanged){h.handleSelectionChanged(a);}}this.setShouldRenderFrame();};u.prototype.setSelectionRect=function(a){this.setShouldRenderFrame();if(!a){this._selectionRect=null;return;}var b=this._renderer.getSize();var x=(a.x1/b.width)*2-1,y=(a.y1/b.height)*-2+1,h=(a.x2/b.width)*2-1,i=(a.y2/b.height)*-2+1;if(!this._selectionRect){var t=new THREE.Geometry();t.vertices.push(new THREE.Vector3(x,i,-1),new THREE.Vector3(h,i,-1),new THREE.Vector3(h,y,-1),new THREE.Vector3(x,y,-1));this._selectionRect=new THREE.LineLoop(t,new THREE.LineBasicMaterial({color:0xC0C000,linewidth:window.devicePixelRatio}));}else{var w=this._selectionRect.geometry.vertices;w[0].set(x,i,-1);w[1].set(h,i,-1);w[2].set(h,y,-1);w[3].set(x,y,-1);this._selectionRect.geometry.verticesNeedUpdate=true;}};u.prototype._renderLoop=function(){if(!this._renderer||!this.getDomRef()){this._renderLoopRequestId=0;return;}if(this._viewportGestureHandler){this._viewportGestureHandler.animateCameraUpdate();}if(this.getCamera()){var a=this._getNativeCamera();if(this._eyePointLight&&a){this._eyePointLight.position.copy(a.position);}if(this.getCamera().getIsModified()){this.getCamera().setIsModified(false);this._shouldRenderFrame=true;}}if(this._shouldRenderFrame){this._shouldRenderFrame=false;this.render();}this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);};var E=new THREE.Vector2();function _(a,b,h){var i=a.getSize();E.set(i.width,i.height);h.children.forEach(function(t){if(t.userData._vkDynamicObjects){t.userData._vkDynamicObjects.forEach(function(w){if(w.layers.test(b.layers)){w._vkUpdate(a,b,E);}});}});}function F(h,i,t,w,x){t.children.forEach(function(y){if(y.userData._vkDetailViews){y.userData._vkDetailViews.sort(function(a,b){return a.renderOrder-b.renderOrder;});y.userData._vkDetailViews.forEach(function(a){if(a.node.layers.test(i.layers)){a.detailView._render(h,i,t,w,x);}});}});}u.prototype.render=function(){var a=this._renderer;if(!a){return;}var b=this._getNativeScene();var h=this._getNativeCamera();if(!b||!h){return;}var t=this._getLayers();h.layers.mask=t?t.mask:(1|0);var w=this.getTools();var x=this._getViewStateManagerThreeJS();var i,y,G,H;if(this._camera.getUsingDefaultClipPlanes()||(h.isOrthographicCamera&&this._camera.getZoomNeedRecalculate())){H=this._scene._computeBoundingBox(t,false);if(!H.isEmpty()){if(h.isOrthographicCamera&&this._camera.getZoomNeedRecalculate()){this._camera.adjustZoom(H);}if(this._camera.getUsingDefaultClipPlanes()){for(i=0;i<w.length;i++){y=sap.ui.getCore().byId(w[i]);G=y.getGizmoForContainer(this);if(G&&G.expandBoundingBox){G.expandBoundingBox(H);}}this._camera.adjustClipPlanes(H);}}}_(a,h,b);a.clippingPlanes=this._clippingPlanes;switch(this.getRenderMode()){case m.XRay:if(x){var I=b.children[b.children.length-1].clone();x._selectedNodes.forEach(function(Q){if(Q.layers.test(h.layers)){Q.add(I);a.render(Q,h);a.autoClear=false;Q.remove(I);}});}b.overrideMaterial=this._xrayMaterial;break;case m.LineIllustration:case m.ShadedIllustration:case m.SolidOutline:this._scene._outlineMaterial.linewidth=this._renderer.getPixelRatio();break;default:break;}a.autoClear=this._backgroundColor!=null;if(a.autoClear){a.setClearColor(this._backgroundColor.color,this._backgroundColor.alpha);}else{a.render(this._backgroundScene,this._backgroundCamera);}if(this.getRenderMode()===m.XRay){a.autoClear=false;}a.render(b,h);a.autoClear=false;a.clippingPlanes=[];b.overrideMaterial=null;F(a,h,b,H,this._eyePointLight);if(x){var J=x._boundingBoxesScene;if(J){x._updateBoundingBoxes();a.render(J,h);}}for(i=0;i<w.length;i++){y=sap.ui.getCore().byId(w[i]);G=y.getGizmoForContainer(this);if(G&&G.render){G.render(this);}}if(this._selectionRect){a.render(this._selectionRect,this._backgroundCamera);}if(x){x._renderOutline(a,b,h);}this.fireFrameRenderingFinished();};u.prototype.getImage=function(a,b,t,i,x){var y=this._getNativeScene();if(!y){return null;}a=Math.min(a||16,2048);b=Math.min(b||16,2048);this._imageCanvas=this._imageCanvas||document.createElementNS("http://www.w3.org/1999/xhtml","canvas");var G=new THREE.WebGLRenderer({canvas:this._imageCanvas,preserveDrawingBuffer:true,antialias:true,alpha:true});G.setSize(a,b);var H=this.getBackgroundColorTop();var I=this.getBackgroundColorBottom();if(t&&!i){G.setClearColor(t,1);}else if(!t&&i){G.setClearColor(i,1);}else{if(t&&i){this.setBackgroundColorTop(t);this.setBackgroundColorBottom(i);}G.render(this._backgroundScene,this._backgroundCamera);G.autoClear=false;}document.body.appendChild(G.domElement);var J=this._getNativeCamera().clone();var Q=a/b;if(J.isOrthographicCamera){var w=J.right-J.left;var h=J.top-J.bottom;if(w>h){J.top=w/Q/2;J.bottom=-w/Q/2;}else{J.left=-h*Q/2;J.right=h*Q/2;}}else{var U=2*Math.atan(J.aspect*Math.tan(J.fov*Math.PI/360));if(J.fov<U*180/Math.PI){J.fov=360*Math.atan(Math.tan(U*0.5)/Q)/Math.PI;}J.aspect=Q;}J.updateProjectionMatrix();var W=[];var X=this._getViewStateManagerThreeJS();if(!x){if(X!==null){X.enumerateSelection(function($){W.push($);});X.setSelectionState(W,false,false,true);}}G.render(y,J);var Y=G.getContext().canvas.toDataURL();if(X!==null&&W.length>0){X.setSelectionState(W,true,false,true);}document.body.removeChild(G.domElement);G.dispose();if(I&&t){this.setBackgroundColorBottom(I);}if(H&&i){this.setBackgroundColorTop(H);}return Y;};u.prototype._setContent=function(a){var b;var h;if(a){b=a;if(!(b instanceof r)){b=null;}h=a.camera;if(!(h instanceof O||h instanceof P)){h=new P();}if(h instanceof O){var t=new THREE.Box3().setFromObject(b.getSceneRef());var w=t.getCenter();var x=h.getTargetDirection();var y=h.getPosition();var G=[w.x-y[0],w.y-y[1],w.z-y[2]];var H=G[0]*x[0]+G[1]*x[1]+G[2]*x[2];if(H<0){var I=t.getSize().length()/2;I-=H;y[0]-=x[0]*I;y[1]-=x[1]*I;y[2]-=x[2]*I;h.setPosition(y);}}var i;if(a.loaders){for(i=0;i<a.loaders.length;i++){if(a.loaders[i]instanceof s){this._cdsLoader=a.loaders[i];this._cdsLoader.attachSceneUpdated(this._handleCdsSceneUpdate,this);break;}}}if(a.builders){for(i=0;i<a.builders.length;i++){a.builders[i]._fireSceneUpdated=this.setShouldRenderFrame.bind(this);a.builders[i]._fireLoadingFinished=function(J){this.setRenderMode(this.getRenderMode());}.bind(this);}}}this.setScene(b);if(h){this.setCamera(h);}if(a){if(a.backgroundTopColor!==undefined){this.setBackgroundColorTop(new THREE.Color(a.backgroundTopColor).getStyle());}if(a.backgroundBottomColor!==undefined){this.setBackgroundColorBottom(new THREE.Color(a.backgroundBottomColor).getStyle());}if(a.renderMode!==undefined){this.setRenderMode(a.renderMode);}}};u.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};u.prototype._onBeforeClearContentConnector=function(){if(z._onBeforeClearContentConnector){z._onBeforeClearContentConnector.call(this);}this.setScene(null);};u.prototype._handleContentReplaced=function(a){var b=a.getParameter("newContent");this._setContent(b);};u.prototype._onAfterUpdateViewStateManager=function(){};u.prototype._onBeforeClearViewStateManager=function(){};C.injectMethodsIntoClass(u);d.injectMethodsIntoClass(u);u.prototype.getCurrentView=function(){return this._currentView;};u.prototype._onViewApplied=function(a,b,h){if(h.source!=this._getViewStateManagerThreeJS()){return;}this._ignoreAnimationPosition=h.ignoreAnimationPosition;this.activateView(h.view);};u.prototype._activateSingleView=function(a){var b=this._scene.getViewGroups();if(b){var t=this;b.forEach(function($){$.getViews().forEach(function(a1){if(a1===a){t._currentViewIndex=$.getViews().indexOf(a1);}});});}this.fireViewActivated({viewIndex:this._currentViewIndex,view:a});v.getEventBus().publish("sap.ui.vk","viewActivated",{source:this,view:a,viewIndex:this._currentViewIndex});this._currentView=a;if(a.topColor!==undefined){this.setBackgroundColorTop(new THREE.Color(a.topColor).getStyle());}if(a.bottomColor!==undefined){this.setBackgroundColorBottom(new THREE.Color(a.bottomColor).getStyle());}if(a.renderMode!==undefined){this.setRenderMode(a.renderMode);}var h=a.camera;if(!h&&a.getCameraInfo()){var i=a.getCameraInfo();if(i.type==="PerspectiveCamera"){h=new P();h.setFov(i.fov);}if(i.type==="OrthographicCamera"){h=new O();h.setZoomFactor(i.zoomFactor);if(i.zoomNeedRecalculate){h.setZoomNeedRecalculate(true);}}h.setPosition(i.position);h.setNearClipPlane(i.nearClipPlane);h.setFarClipPlane(i.farClipPlane);h.setUpDirection(i.upDirection);h.setTargetDirection(i.targetDirection);h.setUsingDefaultClipPlanes(i.usingDefaultClipPlanes);a.camera=h;}var w=this._getNativeScene();if(h){var x=h.getCameraRef();if(x.type==="OrthographicCamera"&&w){var y=h.getPosition();var G=this.getScene();if(G){var H=new THREE.Box3().setFromObject(w);var I=H.getCenter();var J=h.getTargetDirection();var Q=[I.x-y[0],I.y-y[1],I.z-y[2]];var U=Q[0]*J[0]+Q[1]*J[1]+Q[2]*J[2];if(U<0){var W=H.getSize().length()/2;W-=U;y[0]-=J[0]*W;y[1]-=J[1]*W;y[2]-=J[2]*W;}}h.setPosition(y);}}if(h){var X=2000;if(a.flyToTime!=null){X=a.flyToTime;}this._viewportGestureHandler.activateCamera(h.getCameraRef(),X,this._playingProcedure);}else{this.fireViewFinished();var Y=this._getViewStateManagerThreeJS();if(Y){Y.fireReadyForAnimation({view:this._currentView,ignoreAnimationPosition:this._ignoreAnimationPosition});v.getEventBus().publish("sap.ui.vk","readyForAnimation",{source:Y,view:this._currentView,ignoreAnimationPosition:this._ignoreAnimationPosition});}}};u.prototype.resetCurrentView=function(){if(!this._currentView){return this;}this._getViewStateManagerThreeJS()._resetNodesMaterialAndOpacityByCurrenView(this._currentView);this._getViewStateManagerThreeJS()._resetNodesStatusByCurrenView(this._currentView,true,true);this.setShouldRenderFrame();return this;};u.prototype.activateView=function(a,b){this._playingProcedure=false;this._activateSingleView(a);return this;};u.prototype.zoomTo=function(w,a,b,h){var i=this._getNativeScene();var t=this._getNativeCamera();if(!t||!i){return this;}h=h||0;var x=new THREE.Box3();var y=null;var G=null;(Array.isArray(w)?w:[w]).forEach(function(w){switch(w){case Z.All:i._expandBoundingBox(x,null,true);break;case Z.Visible:i._expandBoundingBox(x,this._getLayers(),true);break;case Z.Selected:var H=this._getViewStateManagerThreeJS();if(H){H.enumerateSelection(function(a){a._expandBoundingBox(x,null,true);});}break;case Z.Node:if(!a){return this;}G=a;if(Array.isArray(a)){a.forEach(function(a){a._expandBoundingBox(x,null,true);});}else{a._expandBoundingBox(x,null,true);}break;case Z.Restore:q.sap.log.error(n().getText("VIEWPORT_MSG_RESTORENOTIMPLEMENTED"));return this;case Z.NodeSetIsolation:q.sap.log.error(n().getText("VIEWPORT_MSG_NODESETISOLATIONNOTIMPLEMENTED"));return this;case Z.RestoreRemoveIsolation:q.sap.log.error(n().getText("VIEWPORT_MSG_RESTOREREMOVEISOLATIONNOTIMPLEMENTED"));return this;case Z.ViewLeft:y=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),-Math.PI/2);break;case Z.ViewRight:y=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI/2);break;case Z.ViewTop:y=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2);break;case Z.ViewBottom:y=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2);break;case Z.ViewBack:y=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI);break;case Z.ViewFront:y=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),0);break;default:break;}}.bind(this));if(!x.isEmpty()){this._viewportGestureHandler.zoomTo(x,y,h,b*1000,G,G!==null);}return this;};u.prototype.pan=function(a,b){this._viewportGestureHandler._cameraController.pan(a,b);};u.prototype.rotate=function(a,b){this._viewportGestureHandler._cameraController.rotate(a,b);};u.prototype.zoom=function(a){this._viewportGestureHandler._cameraController.zoom(a);};u.prototype.getViewInfo=function(a){var b={};if(a==null){a={};}if(a.camera==null){a.camera=true;}var h=this._getNativeCamera();if(a.camera&&h){var i=h.rotation.clone();i.reorder("YXZ");b.camera={rotation:{yaw:THREE.Math.radToDeg(i.y),pitch:THREE.Math.radToDeg(i.x),roll:THREE.Math.radToDeg(i.z)},position:{x:h.position.x,y:h.position.y,z:h.position.z},projectionType:h.isOrthographicCamera?j.Orthographic:j.Perspective,bindingType:k.Vertical};var t=h.view;if(t&&t.enabled){b.camera.view={fullWidth:t.fullWidth,fullHeight:t.fullHeight,offsetX:t.offsetX,offsetY:t.offsetY,width:t.width,height:t.height};}if(b.camera.projectionType===j.Perspective){b.camera.fieldOfView=h.fov;}else if(b.camera.projectionType===j.Orthographic){b.camera.zoomFactor=h.zoom;}if(a.camera.matrices){b.camera.matrices={view:h.matrixWorldInverse.elements.slice(),projection:h.projectionMatrix.elements.slice()};}}if(a.visibility&&this._viewStateManager){var w=a.visibility.mode==null?l.Complete:a.visibility.mode;b.visibility={mode:w};if(w===l.Complete){var x=this._viewStateManager.getVisibilityComplete();b.visibility.visible=x.visible;b.visibility.hidden=x.hidden;}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){b.visibility.changes=this._viewStateManager.getVisibilityChanges();}else{q.sap.log.warning(n().getText(M.VIT32.summary),M.VIT32.code,"sap.ui.vk.threejs.Viewport");}}return b;};u.prototype.setViewInfo=function(a,b){var h=this._getNativeCamera();if(a.camera&&h){var i=a.camera;var t=i.projectionType===j.Orthographic?new THREE.OrthographicCamera():new THREE.PerspectiveCamera();t.userData=h.userData;t.aspect=h.aspect;t.position.copy(i.position);var w=i.rotation;t.quaternion.setFromEuler(new THREE.Euler(THREE.Math.degToRad(w.pitch),THREE.Math.degToRad(w.yaw),THREE.Math.degToRad(w.roll),"YXZ"));t.fov=i.fieldOfView||t.fov;t.zoom=i.zoomFactor||t.zoom;if(h.view&&h.view.enabled){var x=i.view||h.view;t.setViewOffset(x.fullWidth,x.fullHeight,x.offsetX,x.offsetY,x.width,x.height);t.aspect=x.fullWidth/x.fullHeight;t.zoom=Math.min(t.aspect,1);}this._viewportGestureHandler.activateCamera(t,(b||0)*1000);}if(a.visibility){var y=this._viewStateManager.getNodeHierarchy(),G=new Map(),H=y.findNodesByName();H.forEach(function(Q){var U=y.createNodeProxy(Q);var W=U.getVeId();y.destroyNodeProxy(U);if(W){G.set(W,Q);}});switch(a.visibility.mode){case l.Complete:var I=a.visibility.visible,J=a.visibility.hidden;I.forEach(function(Q){this._viewStateManager.setVisibilityState(G.get(Q),true,false);},this);J.forEach(function(Q){this._viewStateManager.setVisibilityState(G.get(Q),false,false);},this);break;case l.Differences:this._viewStateManager.resetVisibility();a.visibility.changes.forEach(function(Q){var U=G.get(Q);if(U){this._viewStateManager.setVisibilityState(U,!this._viewStateManager.getVisibilityState(U),false);}},this);break;default:q.sap.log.error(n().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.threejs.Viewport");break;}}this.setShouldRenderFrame();return this;};u.prototype.queueCommand=function(a){if(this instanceof u){a();}return this;};u.prototype.getOutputSize=function(){var b=this.getDomRef().getBoundingClientRect();var a=b.width;var h=b.height;var i;i=Math.min(a,h);return{left:(a-i)/2,top:(h-i)/2,sideLength:i};};return u;});
