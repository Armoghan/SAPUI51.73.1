/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../Core","../ContentConnector","../ViewStateManagerBase","./thirdparty/three","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","../ObjectType","../RotationType","./NodesTransitionHelper","./OutlineRenderer"],function(v,C,V,t,a,b,d,e,S,O,R,N,f){"use strict";var g;var h=V.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{}});var j=h.getMetadata().getParent().getClass().prototype;h.prototype.init=function(){if(j.init){j.init.call(this);}this._channel=0;this._layers=new THREE.Layers();this._layers.set(this._channel);this._nodeHierarchy=null;this._nodeStates=new Map();this._selectedNodes=new Set();this._outlineRenderer=new f(1.0);this._outlinedNodes=new Set();this.setOutlineColor("rgba(255, 0, 255, 1.0)");this.setOutlineWidth(1.0);this._visibilityTracker=new g();this._showSelectionBoundingBox=true;this._boundingBoxesScene=new THREE.Scene();this._selectionColor=new THREE.Color(0xC0C000);this.setHighlightColor("rgba(255, 0, 0, 1.0)");this._joints=[];this._customPositionedNodes=new Set();this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewStateManager(this);v.getEventBus().subscribe("sap.ui.vk","activateView",this._onViewActivated,this);};h.prototype.exit=function(){v.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onViewActivated,this);};h.prototype._setContent=function(c){var s=null;if(c&&c instanceof S){s=c;}this._setScene(s);if(s){var i=s.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrenView(this._currentView);}}};h.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};h.prototype._onBeforeClearContentConnector=function(){this._setScene(null);};h.prototype._handleContentReplaced=function(c){var i=c.getParameter("newContent");this._setContent(i);};h.prototype._setScene=function(s){this._boundingBoxesScene=new THREE.Scene();this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);if(s){s.setViewStateManager(this);}this._scene=s;return this;};h.prototype._setNodeHierarchy=function(n){var o=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._outlinedNodes.clear();this._visibilityTracker.clear();}if(n){this._nodeHierarchy=n;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._initialState={visible:[],hidden:[]};var c=this;var i=n.findNodesByName();i.forEach(function(k){(k.layers.test(c._layers)?c._initialState.visible:c._initialState.hidden).push(k);});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden});}if(n!==o){this.fireNodeHierarchyReplaced({oldNodeHierarchy:o,newNodeHierarchy:n});}return this;};h.prototype._handleNodeReplaced=function(c){var r=c.getParameter("ReplacedNodeRef");var i=c.getParameter("ReplacementNodeRef");if(this.getSelectionState(r)){this.setSelectionState(i,true);this.setSelectionState(r,false);}};h.prototype._handleNodeUpdated=function(c){var n=c.getParameter("nodeRef");if(this.getSelectionState(n)){this.setSelectionState(n,false);this.setSelectionState(n,true);}};h.prototype._renderOutline=function(r,s,i){var c=d(this._outlineColorABGR);var k=new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0);this._outlineRenderer.render(r,s,i,Array.from(this._outlinedNodes),k);};h.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};h.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};h.prototype.getVisibilityComplete=function(){var n=this.getNodeHierarchy(),c=n.findNodesByName(),i=[],k=[];c.forEach(function(l){var m=n.createNodeProxy(l);var o=m.getVeId();n.destroyNodeProxy(m);if(o){if(this.getVisibilityState(l)){i.push(o);}else{k.push(o);}}},this);return{visible:i,hidden:k};};h.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();};h.prototype.getVisibilityState=function(n){var l=this._layers;return Array.isArray(n)?n.map(function(c){return c.layers.test(l);}):n.layers.test(l);};h.prototype.setVisibilityState=function(n,c,r){if(!Array.isArray(n)){n=[n];}var i=Array.isArray(c);var k=[];var l=n;if(r){l=[];n.forEach(function(w,x){var y=this._collectNodesRecursively(w);l=l.concat(y);var z=k.length;k.length=z+y.length;k.fill(i?c[x]:c,z);},this);}else if(!i){k.length=l.length;k.fill(c);}else{k=c;}var m=[];var u=new Set();var o=this._layers,p=this._channel;var q=l.filter(function(w,x){if(u.has(w)){return false;}u.add(w);var q=w?w.layers.test(o)!=k[x]:false;if(q){m.push(k[x]);}return q;},this);if(q.length>0){var s={visible:[],hidden:[]};q.forEach(function(w,x){w.layers[m[x]?"enable":"disable"](p);if(m[x]){var y=this._nodeHierarchy.getAncestors(w);this.setVisibilityState(y,true,false);s.visible.push(w);}else{s.hidden.push(w);}},this);if(this.getShouldTrackVisibilityChanges()){q.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}this.fireVisibilityChanged(s);}return this;};h.prototype.enumerateSelection=function(c){this._selectedNodes.forEach(c);return this;};h.prototype.enumerateOutlinedNodes=function(c){this._outlinedNodes.forEach(c);return this;};h.prototype.getSelectionState=function(n){var s=this._selectedNodes;function i(c){return s.has(c);}return Array.isArray(n)?n.map(i):i(n);};h.prototype._isAChild=function(c,n){var i=c.parent;while(i){if(n.has(i)){return true;}i=i.parent;}return false;};h.prototype._AddBoundingBox=function(n){if(n.userData.boundingBox===undefined){n.userData.boundingBox=new THREE.Box3();n._vkCalculateObjectOrientedBoundingBox();}if(!n.userData.boundingBox.isEmpty()&&this._boundingBoxesScene&&n.userData.boxHelper===undefined){var c=new THREE.Box3Helper(n.userData.boundingBox,0xffff00);c.material.color=this._selectionColor;this._boundingBoxesScene.add(c);c.parent=n;n.userData.boxHelper=c;}};h.prototype._RemoveBoundingBox=function(n){if(n.userData.boundingBox!==undefined){delete n.userData.boundingBox;}if(n.userData.boxHelper!==undefined){this._boundingBoxesScene.remove(n.userData.boxHelper);delete n.userData.boxHelper;}};h.prototype._updateBoundingBoxesIfNeeded=function(){var u=new Set();this._selectedNodes.forEach(function(n){var p=n.parent;while(p){if(this._selectedNodes.has(p)){u.add(p);}p=p.parent;}}.bind(this));u.forEach(function(n){n._vkCalculateObjectOrientedBoundingBox();});};h.prototype._updateBoundingBoxes=function(){this._selectedNodes.forEach(function(n){if(n.userData.boundingBox){n._vkCalculateObjectOrientedBoundingBox();}});};h.prototype.setShowSelectionBoundingBox=function(c){this._showSelectionBoundingBox=c;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(n){this._AddBoundingBox(n);}.bind(this));}else{this._selectedNodes.forEach(function(n){this._RemoveBoundingBox(n);}.bind(this));}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]});};h.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox;};h.prototype._isAncestorSelected=function(n){n=n.parent;while(n){if(this._selectedNodes.has(n)){return true;}n=n.parent;}return false;};h.prototype._updateHighlightColor=function(n,p){var s=p||this._selectedNodes.has(n);n.userData.highlightColor=s?this._highlightColorABGR:undefined;n._vkUpdateMaterialColor();var c=n.children;for(var i=0,l=c.length;i<l;i++){var u=c[i].userData;if(u&&u.objectType===O.Hotspot){continue;}this._updateHighlightColor(c[i],s);}};h.prototype.setSelectionState=function(n,s,r,c){if(!Array.isArray(n)){n=[n];}n=(r||this.getRecursiveSelection()?this._collectNodesRecursively(n):n).filter(function(k,l,m){return m.indexOf(k)===l;});if(this.getRecursiveSelection()&&!s){n=this._nodeHierarchy._appendAncestors(n);}var i=n.filter(function(k){return this._selectedNodes.has(k)!==s;},this);if(i.length>0){i.forEach(function(k){if(k){this._selectedNodes[s?"add":"delete"](k);if(this._showSelectionBoundingBox){this[s?"_AddBoundingBox":"_RemoveBoundingBox"](k);}}},this);i.forEach(function(k){if(k){this._updateHighlightColor(k,s||this._isAncestorSelected(k));}},this);if(!c){this.fireSelectionChanged({selected:s?i:[],unselected:s?[]:i});}}return this;};h.prototype.setSelectionStates=function(s,u,r,c){if(!Array.isArray(s)){s=[s];}if(!Array.isArray(u)){u=[u];}s=(r||this.getRecursiveSelection()?this._collectNodesRecursively(s):s);u=(r||this.getRecursiveSelection()?this._collectNodesRecursively(u):u);if(this.getRecursiveSelection()){u=this._nodeHierarchy._appendAncestors(u,s);}var i=s.filter(function(n){return this._selectedNodes.has(n)===false;},this);var k=u.filter(function(n){return this._selectedNodes.has(n)===true;},this);if(i.length>0||k.length>0){i.forEach(function(n){this._selectedNodes.add(n);this._updateHighlightColor(n,true);if(this._showSelectionBoundingBox){this._AddBoundingBox(n);}},this);k.forEach(function(n){this._selectedNodes.delete(n);if(this._showSelectionBoundingBox){this._RemoveBoundingBox(n);}},this);k.forEach(function(n){this._updateHighlightColor(n,this._isAncestorSelected(n));},this);if(!c){this.fireSelectionChanged({selected:i,unselected:k});}}return this;};h.prototype.setOutlineColor=function(c){switch(typeof c){case"number":this._outlineColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._outlineColorABGR=e(a(c));}break;default:return this;}this.fireOutlineColorChanged({outlineColor:b(d(this._outlineColorABGR)),outlineColorABGR:this._outlineColorABGR});return this;};h.prototype.getOutlineColor=function(i){return i?this._outlineColorABGR:b(d(this._outlineColorABGR));};h.prototype.getOutliningState=function(n){var o=this._outlinedNodes;function i(c){return o.has(c);}return Array.isArray(n)?n.map(i):i(n);};h.prototype.setOutliningStates=function(o,u,r,c){if(!Array.isArray(o)){o=[o];}if(!Array.isArray(u)){u=[u];}o=(r||this.getRecursiveOutlining()?this._collectNodesRecursively(o):o);u=(r||this.getRecursiveOutlining()?this._collectNodesRecursively(u):u);if(this.getRecursiveOutlining()){u=this._nodeHierarchy._appendAncestors(u,o);}var i=o.filter(function(n){return this._outlinedNodes.has(n)===false;},this);var k=u.filter(function(n){return this._outlinedNodes.has(n)===true;},this);if(i.length>0||k.length>0){i.forEach(function(n){this._outlinedNodes.add(n);},this);k.forEach(function(n){this._outlinedNodes.delete(n);},this);if(!c){this.fireOutliningChanged({outlined:i,unoutlined:k});}}return this;};h.prototype.setOutlineWidth=function(w){this._outlineWidth=w;this._outlineRenderer.setOutlineWidth(w);this.fireOutlineWidthChanged({width:w});return this;};h.prototype.getOutlineWidth=function(){return this._outlineWidth;};h.prototype._collectNodesRecursively=function(n){var r=[],c=this;if(!Array.isArray(n)){n=[n];}n.forEach(function collectChildNodes(i){r.push(i);c._nodeHierarchy.enumerateChildren(i,collectChildNodes,false,true);});return r;};h.prototype._getOpacity=function(n){return n.userData.opacity!==undefined?n.userData.opacity:null;};h.prototype.getOpacity=function(n){if(Array.isArray(n)){return n.map(this._getOpacity,this);}else{return this._getOpacity(n);}};h.prototype.setOpacity=function(n,o,r){if(!Array.isArray(n)){n=[n];}var i=Array.isArray(o);if(o==null){o=undefined;}else if(i){o.forEach(function(q,s){if(q==null){o[s]=undefined;}});}var c=[];var k=n;if(r){k=[];n.forEach(function(q,s){var w=this._collectNodesRecursively(q);k=k.concat(w);var x=c.length;c.length=x+w.length;c.fill(i?o[s]:o,x);},this);}else if(!i){c.length=k.length;c.fill(o);}else{c=o;}var l=[];var u=new Set();var m=k.filter(function(q,s){if(u.has(q)){return false;}u.add(q);var m=q?q.userData.opacity!==c[s]:false;if(m){l.push(c[s]);}return m;},this);if(m.length>0){m.forEach(function(q,s){q._vkSetOpacity(l[s]);},this);var p={changed:m,opacity:i?l:l[0]};this.fireOpacityChanged(p);}return this;};h.prototype._getTintColorABGR=function(n){return n.userData.tintColor!==undefined?n.userData.tintColor:null;};h.prototype._getTintColor=function(n){return n.userData.tintColor!==undefined?b(d(n.userData.tintColor)):null;};h.prototype.getTintColor=function(n,i){var c=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(n)){return n.map(this[c],this);}else{return this[c](n);}};h.prototype.setTintColor=function(n,c,r){if(!Array.isArray(n)){n=[n];}var i=function(w){var x=null;switch(typeof w){case"number":x=w;break;case"string":if(sap.ui.core.CSSColor.isValid(w)){x=e(a(w));}break;default:x=undefined;break;}return x;};var k=Array.isArray(c);var l=[];var m=n;if(r){m=[];n.forEach(function(w,x){var y=this._collectNodesRecursively(w);m=m.concat(y);var z=l.length;l.length=z+y.length;l.fill(k?c[x]:c,z);},this);}else if(!k){l.length=m.length;l.fill(c);}else{l=c;}var o=[];var u=new Set();var p=m.filter(function(w,x){if(u.has(w)){return false;}u.add(w);var p=w?w.userData.tintColor!==i(l[x]):false;if(p){o.push(l[x]);}return p;},this);if(p.length>0){var q=[];p.forEach(function(w,x){var y=i(o[x]);w._vkSetTintColor(y);q.push(y);},this);var s={changed:p,tintColor:k?o:o[0],tintColorABGR:k?q:q[0]};this.fireTintColorChanged(s);}return this;};h.prototype.setHighlightColor=function(c){switch(typeof c){case"number":this._highlightColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._highlightColorABGR=e(a(c));}break;default:return this;}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(n){this._updateHighlightColor(n,true);},this);}this.fireHighlightColorChanged({highlightColor:b(d(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};h.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:b(d(this._highlightColorABGR));};h.prototype.getTransformation=function(n){var c=function(i){return{translation:this.getTranslation(i),quaternion:this.getRotation(i,R.Quaternion),scale:this.getScale(i)};}.bind(this);if(!Array.isArray(n)){return c(n);}var r=[];n.forEach(function(i){r.push(c(i));});return r;};h.prototype.getTranslation=function(n){var c=function(i){return!i.userData.position?i.position.toArray():i.userData.position.toArray();};if(!Array.isArray(n)){return c(n);}var r=[];n.forEach(function(i){r.push(c(i));});return r;};h.prototype.getScale=function(n){var c=function(i){return!i.userData.scale?i.scale.toArray():i.userData.scale.toArray();};if(!Array.isArray(n)){return c(n);}var r=[];n.forEach(function(i){r.push(c(i));});return r;};h.prototype.getRotation=function(n,r){var c=function(k){var q=!k.userData.quaternion?k.quaternion:k.userData.quaternion;var i;switch(r){case R.AngleAxis:if(q.w>1){q.normalize();}var l=2*Math.acos(q.w);var x;var y;var z;var s=Math.sqrt(1-q.w*q.w);if(s<0.0001){x=1;y=0;z=0;}else{x=q.x/s;y=q.y/s;z=q.z/s;}i=[x,y,z,l];break;case R.Euler:var m=new THREE.Euler();m.setFromQuaternion(q);i=m.toArray();break;default:i=q.toArray();}return i;};if(!Array.isArray(n)){return c(n);}var i=[];n.forEach(function(k){i.push(c(k));});return i;};h.prototype.setTransformation=function(n,c){var i=Array.isArray(n);if(!Array.isArray(n)){n=[n];}var k={changed:[],transformation:[]};var l=function(m){return{position:m.position.toArray(),quaternion:m.quaternion.toArray(),scale:m.scale.toArray()};};if(!c){n.forEach(function(m){if(m.userData.position&&m.userData.quaternion&&m.userData.scale){m.position=m.userData.position;m.quaternion=m.userData.quaternion;m.scale=m.userData.scale;delete m.userData.position;delete m.userData.quaternion;delete m.userData.scale;}this._customPositionedNodes.delete(m);k.changed.push(m);k.transformation.push(l(m));},this);}else{if(!Array.isArray(c)){c=[c];}n.forEach(function(m,o){if(!m.userData.position||m.userData.quaternion||m.userData.scale){m.userData.position=m.position.clone();m.userData.quaternion=m.quaternion.clone();m.userData.scale=m.scale.clone();}var p=c[o];m.position.fromArray(p.translation);m.scale.fromArray(p.scale);if(p.quaternion){m.quaternion.fromArray(p.quaternion);}else if(p.angleAxis){var q=new THREE.Vector3(p.angleAxis[0],p.angleAxis[1],p.angleAxis[2]);m.quaternion.setFromAxisAngle(q,p.angleAxis[3]);}else if(p.euler){var r=new THREE.Euler();r.fromArray(p.euler[0],p.euler[1],p.euler[2],p.euler[3]);m.quaternion.setFromEuler(r);}this._customPositionedNodes.add(m);k.changed.push(m);k.transformation.push(l(m));},this);}if(!i){k.changed=k.changed[0];k.transformation=k.transformation[0];}this.fireTransformationChanged(k);return this;};h.prototype.getJoints=function(){return this._jointCollection;};h.prototype.setJoints=function(c){this._jointCollection=c;return this;};h.prototype._updateMaterialInNode=function(n){var c=n.target;var i,k;if(c&&c.children){for(i=0;i<c.children.length;i++){k=c.children[i];if(k.userData&&(k.userData.animatedOpacity||k.userData.animatedColor)){k._vkUpdateMaterialColor();k._vkUpdateMaterialOpacity();if(k.userData.animatedOpacity){k.material.transparent=true;}}}}var o=c.userData.materialId;var l=c.userData.opacity;c.userData.materialId=n.materialId;c.userData.opacity=n.opacity;var r=false;if(o===undefined){if(c.userData.materialId!==undefined){r=true;}}else if(o!==c.userData.materialId){r=true;}var m=false;if(l===undefined){if(c.userData.opacity!==undefined||c.userData.animatedOpacity){m=true;}}else if(l!==c.userData.opacity){m=true;}if(!r&&!m){return;}var p=null;if(c.userData.materialId){var q=this._scene.getMaterial(c.userData.materialId);if(q){p=q.getMaterialRef();}}if(c&&c.children){for(i=0;i<c.children.length;i++){k=c.children[i];if(p){k.material=p;k.userData.materialId=n.materialId;}else if(k.userData&&k.userData.initialMaterialId){var s=this._scene.getMaterial(k.userData.initialMaterialId);if(s){var u=s.getMaterialRef();k.material=u;k.userData.materialId=k.userData.initialMaterialId;}}if(k.material&&k.material.userData){k.userData.originalMaterial=k.material;k.material=k.material.clone();if(c.userData.opacity!==undefined){k.userData.opacity=c.userData.opacity;k.material.opacity*=k.userData.opacity;k.material.transparent=k.material.opacity<0.99;}if(k.userData.animatedOpacity){k.material.transparent=true;}}}}};h.prototype._resetNodesStatusByCurrenView=function(c,s,i){function k(x){return new THREE.Matrix4().set(x[0],x[1],x[2],x[3],x[4],x[5],x[6],x[7],x[8],x[9],x[10],x[11],0,0,0,1);}var n=this.getNodeHierarchy();if(n){var p;if(c){p=c.getPlaybacks();}var l=c.getNodeInfos();if(l){this._nodesTransitionHelper.clear();var m={nodeRefs:[],positions:[]};var o=new THREE.Vector3();var q=new THREE.Quaternion();var r=new THREE.Vector3();l.forEach(function(x){if(x.target===null){return;}function y(B,D,E){for(var F=0;F<B.elements.length;F++){if(Math.abs(B.elements[F]-D.elements[F])>E){return false;}}return true;}if(x.transform){var z=k(x.transform);if(!y(z,x.target.matrix,1e-6)){if((!p||!p.length)&&i){var A=n.createNodeProxy(x.target);this._nodesTransitionHelper.setNodeForDisplay(A,z);}else{z.decompose(o,q,r);m.nodeRefs.push(x.target);m.positions.push({translation:o.toArray(),quaternion:q.toArray(),scale:r.toArray()});}}}else if(x.scale&&x.rotate&&x.translate){m.nodeRefs.push(x.target);m.positions.push({translation:x.translate.slice(),quaternion:x.rotate.slice(),scale:x.scale.slice()});}}.bind(this));if(m.nodeRefs.length){this.setTransformation(m.nodeRefs,m.positions);}if(s){var u=[];var w=[];l.forEach(function(x){(x.visible?u:w).push(x.target);});this.setVisibilityState(n.getChildren()[0].children,false,true);this.setVisibilityState(u,true,false);this.setVisibilityState(w,false,false);this._startViewChangeNodeTransition();}}}};h.prototype._startViewChangeNodeTransition=function(){this._nodesTransitionHelper.startDisplay(500);var c=true;this._nodesTransitionHelper.attachEventOnce("displayed",function(){c=false;});var i=function(){if(c){this._nodesTransitionHelper.displayNodesMoving();window.requestAnimationFrame(i);}}.bind(this);window.requestAnimationFrame(i);};h.prototype._resetNodesMaterialAndOpacityByCurrenView=function(c){if(!c){return;}var n=c.getNodeInfos();if(n){n.forEach(function(i){if(i.target===null){return;}this._updateMaterialInNode(i);}.bind(this));}};h.prototype._onViewActivated=function(c,i,k){var l=this.getViewManager();if(!l||k.source.getId()!==l){return;}this.activateView(k.view,false);};h.prototype.activateView=function(c,i){this.fireViewStateApplying({view:c});this.setJoints(undefined);this._customPositionedNodes.clear();this._resetNodesMaterialAndOpacityByCurrenView(c);this._resetNodesStatusByCurrenView(c,true,true,true);this.fireViewStateApplied({view:c,ignoreAnimationPosition:i});v.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:c,ignoreAnimationPosition:i});return this;};g=function(){this._visibilityChanges=new Set();};g.prototype.getInfo=function(n){var c=[];this._visibilityChanges.forEach(function(i){var k=n.createNodeProxy(i);var l=k.getVeId();n.destroyNodeProxy(k);if(l){c.push(l);}else{c.push(n.getScene().nodeRefToPersistentId(i));}});return c;};g.prototype.clear=function(){this._visibilityChanges.clear();};g.prototype.trackNodeRef=function(n){if(this._visibilityChanges.has(n)){this._visibilityChanges.delete(n);}else{this._visibilityChanges.add(n);}};C.injectMethodsIntoClass(h);return h;});
