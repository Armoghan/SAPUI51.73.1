/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./thirdparty/three","../View","../AnimationPlayback","../AnimationTrackType","../AnimationTrackValueType","../AnimationTrackValueTypeSize","../AnimationMath"],function(t,V,A,a,b,d,e){"use strict";var f=function(){};f.prototype._getChildNodesWithMaterial=function(p,c){for(var g=0;p.children&&g<p.children.length;g++){var h=p.children[g];if(h&&h.material&&h.material.color){c.push(h);}this._getChildNodesWithMaterial(h,c);}};f.prototype.addAnimationTracksToHighlight=function(h){var g=h.duration;if(!h.cycles){h.cycles=0;}else{g/=2;}var n=false;var o;for(o=0;h.opacities&&o<h.opacities.length;o++){if(h.opacities[o]!==1){n=true;break;}}var i;var k;var j;if(n){i={};i.times=[];i.values=[];j=h.duration/h.opacities.length;for(k=0;k<h.cycles+1;k++){for(o=0;o<h.opacities.length;o++){i.values.push(h.opacities[o]);i.times.push(j*(k*h.opacities.length+o));if(h.type==="STATIC"){break;}}if(h.type==="STATIC"){break;}}i.data={};i.data.type="OPACITY";i.data.highlight=h;h.duration=i.times[i.times.length-1];}var l=false;var m;for(m=0;h.colours&&m<h.colours.length;m++){var c=h.colours[m];if(c[3]!==0&&(c[0]!==0||c[1]!==0||c[2]!==0)){l=true;break;}}var p;if(l){if(h.type==="INFINITE"&&h.colours.length===1){var q=[0,0,0,0];h.colours.push(q);}p={};p.times=[];p.values=[];j=h.duration/h.colours.length;for(k=0;k<h.cycles+1;k++){for(m=0;m<h.colours.length;m++){var r=h.colours[m];p.values.push(r[0],r[1],r[2],r[3]);p.times.push(j*(k*h.opacities.length+m));if(h.type==="STATIC"){break;}}if(h.type==="STATIC"){break;}}p.data={};p.data.type="COLOR";p.data.highlight=h;h.duration=p.times[p.times.length-1];}if(p){h.colorTrack=p;}if(i){h.opacityTrack=i;}};f.prototype.processHighlights=function(v,c,s){return;};f.prototype._processHighlight=function(h,c,r){if(!h||(!h.opacityTrack&&!h.colorTrack)||!c){return;}if(!c.userData.highlights){c.userData.highlights=new Map();}for(var g=0;h.highlightNodes&&g<h.highlightNodes.length;g++){var n=h.highlightNodes[g];var i=[];if(n.material&&n.material.color){i.push(n);}else{this._getChildNodesWithMaterial(n,i);}if(i.length===0){continue;}var s=c.userData.highlights.get(n);if(s&&(!r)){continue;}else{c.userData.highlights.set(n,h);}if(h.opacityTrack){if(h.type==="STATIC"&&h.opacityTrack.values.length===1){h.opacityTrack.times.push(c.userData.maxDuration);h.opacityTrack.values.push(h.opacityTrack.values[h.opacityTrack.values.length-1]);}c.setOpacityTrack(n,h.opacityTrack.times,h.opacityTrack.values,"linear",true);}if(h.colorTrack){var j=false;if(h.colorTrack.times.length>1&&h.type!=="INFINITE"){j=true;}for(var k=0;k<i.length;k++){var N=i[k];var l=N.material;if(N.userData&&N.userData.originalMaterial){l=N.userData.originalMaterial;}var m=new THREE.Color();var o;var p={};p.times=[];p.values=[];p.data=h.colorTrack.data;var q=0.0;if(j){q=0.05;p.times.push(0.0);p.values.push(l.color.r,l.color.g,l.color.b);}for(o=0;o<h.colorTrack.times.length;o++){p.times.push(h.colorTrack.times[o]+q);m.fromArray(h.colorTrack.values,o*4).lerp(l.color,1-h.colorTrack.values[o*4+3]);p.values.push(m.r,m.g,m.b);}if(j){p.times.push(p.times[p.times.length-1]+0.05);p.values.push(l.color.r,l.color.g,l.color.b);}if(h.type==="INFINITE"){var u=0.05;if(p.times.length>1){u=p.times[p.times.length-1]-p.times[p.times.length-2];}q=p.times[p.times.length-1]+u;var v=q;while(v<c.userData.maxDuration){for(o=0;o<h.colorTrack.times.length&&v<c.userData.maxDuration;o++){v=h.colorTrack.times[o]+q;p.times.push(v);m.fromArray(h.colorTrack.values,o*4).lerp(l.color,1-h.colorTrack.values[o*4+3]);p.values.push(m.r,m.g,m.b);}q=v+u;}}if(h.type==="STATIC"&&p.values.length===1){p.times.push(c.userData.maxDuration);var w=p.values[p.values.length-3];var x=p.values[p.values.length-2];var y=p.values[p.values.length-1];p.values.push(w,x,y);}c.setColorTrack(N,p.times,p.values,"linear",true);}}}};f.prototype._getVkTrackType=function(c){switch(c.type){case"TRANSLATE":return a.Translate;case"ROTATE":return a.Rotate;case"SCALE":return a.Scale;case"OPACITY":return a.Opacity;case"COLOR":return a.Color;default:}};f.prototype._getVkTrackValueType=function(c,r){switch(c.type){case"TRANSLATE":return b.Vector3;case"ROTATE":if(r==="quaternion"){return b.Quaternion;}else if(r==="angleAxis"){return b.AngleAxis;}else if(r==="euler"){return b.Euler;}break;case"SCALE":return b.Vector3;case"OPACITY":return b.Scalar;case"COLOR":return b.Vector3;default:}};f.prototype.insertTracks=function(c,g,n,s){c.forEach(function(h){var i=g.get(h.id);var v=s.findTrack(h.id.toString());if(Array.isArray(i)&&i.length){if(!v){var k=this._getVkTrackValueType(i[0],h.rotateType);var l=d.get(k);v=s.createTrack(h.id.toString(),{trackValueType:k,cycleForward:h.cyclicInfo.cyclicEnd,cycleBackward:h.cyclicInfo.cyclicStart,infinite:h.infinite});h.times.forEach(function(m,o){var p;if(k===b.Scalar){p=h.values[o];}else{p=[];for(var j=0;j<l;j++){p.push(h.values[o*l+j]);}}v.insertKey(m,p);});}i.forEach(function(j){var m=s.findSequence(j.sequenceId);var o=n.get(j.targetId);if(m&&o){m.setNodeAnimation(o,this._getVkTrackType(j),v);}},this);}},this);return this;};f.prototype.setInitialNodePositionsFromSubsequentViews=function(v,s,o){if(!v||!v.length){return;}var c;var n;var g;var h=new Map();for(var i=v.length-1;i>0;i--){var j=v[i];var k;if(j){k=j.getPlaybacks();}if(k){for(var p=k.length-1;p>=0;p--){var l=k[p];if(l){c=s.findSequence(l.getSequence().getId());if(c){if(o&&!c.hasHighlight()){continue;}if(!l.getReversed()){n=c.getNodesStartValues().entries();}else{n=c.getNodesEndValues().entries();}g=n.next();while(!g.done){h.set(g.value[0],g.value[1]);g=n.next();}}}}}var m=v[i-1];if(m){if(!m.userData){m.userData={};}if(!m.userData.nodeStartDataByAnimation){m.userData.nodeStartDataByAnimation=new Map();}n=h.entries();g=n.next();while(!g.done){m.userData.nodeStartDataByAnimation.set(g.value[0],g.value[1]);g=n.next();}}}};f.prototype.setInitialNodePositionsFromPreviousViews=function(v,s,o){if(!v||!v.length){return;}var c;var n;var g;var h=new Map();for(var i=0;i<v.length-1;i++){var p=v[i];var j;if(p){j=p.getPlaybacks();}if(j){for(var k=0;k<j.length;k++){var l=j[k];if(l){c=s.findSequence(l.getSequence().getId());if(c){if(o&&!c.hasHighlight()){continue;}if(!l.getReversed()){n=c.getNodesEndValues().entries();}else{n=c.getNodesStartValues().entries();}g=n.next();while(!g.done){h.set(g.value[0],g.value[1]);g=n.next();}}}}}var m=v[i+1];if(m){if(!m.userData){m.userData={};}if(!m.userData.nodeStartDataByAnimation){m.userData.nodeStartDataByAnimation=new Map();}n=h.entries();g=n.next();while(!g.done){m.userData.nodeStartDataByAnimation.set(g.value[0],g.value[1]);g=n.next();}}}};f.prototype.setInitialNodePositionsOnView=function(v,s,o){if(!v){return;}var n;var c;var g=0;var h=null;h=v.getPlaybacks();if(!h||!h.length){return;}if(!v.userData){v.userData={};}if(!v.userData.nodeStartDataByAnimation){v.userData.nodeStartDataByAnimation=new Map();}for(var i=h.length-1;i>=g;i--){var p=h[i];var j=s.findSequence(p.getSequence().getId());if(j){if(o&&!j.hasHighlight()){continue;}if(p.getReversed()){n=j.getNodesEndValues().entries();}else{n=j.getNodesStartValues().entries();}c=n.next();while(!c.done){v.userData.nodeStartDataByAnimation.set(c.value[0],c.value[1]);c=n.next();}}}};f.prototype.setInitialNodePositionsFromCurrenetViews=function(v,s,o){if(!v||!v.length){return;}for(var c=0;c<v.length;c++){var g=v[c];if(!g){continue;}this.setInitialNodePositionsOnView(g,s,o);}};f.prototype.setPlaybackStartTimes=function(v,s){if(!v||!v.length){return;}for(var c=0;c<v.length;c++){var g=v[c];if(!g){continue;}var h=null;if(g){h=g.getPlaybacks();}if(!h||!h.length){continue;}var i=0;for(var j=0;j<h.length;j++){var p=h[j];p.setStartTime(i);i+=p.getDuration();}}};f.prototype.prepareViewForAnimation=function(v){var n=v.getNodeInfos();if(!n){return;}if(!v.userData){v.userData={};}if(!v.userData.nodesDataByView){v.userData.nodesDataByView=new Map();}else{return;}function c(k){return new THREE.Matrix4().set(k[0],k[1],k[2],k[3],k[4],k[5],k[6],k[7],k[8],k[9],k[10],k[11],0,0,0,1);}for(var g=0;g<n.length;g++){var h=n[g];if(!h||!h.target){continue;}var i={};if(h.transform){i.position=new THREE.Vector3();i.scale=new THREE.Vector3();i.quaternion=new THREE.Quaternion();var j=c(h.transform);j.decompose(i.position,i.quaternion,i.scale);v.userData.nodesDataByView.set(h.target,i);}}};f.prototype.getNodePositionByView=function(v,n){var c;if(!v){return c;}if(!v.userData||!v.userData.nodesDataByView){this.prepareViewForAnimation(v);}if(v.userData&&v.userData.nodesDataByView){c=v.userData.nodesDataByView.get(n);}return c;};f.prototype.getNodePositionFromNearestPlayback=function(s,v,c,n){var g;if(!v||!s){return g;}var p=v.getPlaybacks();if(!p){return g;}var h;var i;var j=0;for(h=0;h<p.length;h++){i=p[h];if(c==i.getSequenceId()){j=i.getStartTime();break;}}var m=0;for(h=0;h<p.length;h++){i=p[h];var k=i.getStartTime();if(j<=k){continue;}if(c==i.getSequenceId()){continue;}var l=s.findSequence(i.getSequenceId());if(l){var o;if(i.getReversed()){o=l.getNodesStartValues();}else{o=l.getNodesEndValues();}var q=o.get(n);if(q&&k>=m){g=q;m=k;}}}return g;};f.prototype._buildViewInitialState=function(v,c,s){var g=c.indexOf(v);if(g<0){return undefined;}var i;var j;var p;var h=new Map();var k=function(n,m,o){var q=h.get(n);if(!q){q={target:n};h.set(n,q);}q[m]=o;};var l=function(m,u){if(!m){return;}var n=m.getNodeAnimation();if(n){n.forEach(function(o){var q=o.nodeRef;for(var r in a){var w=a[r];var x=o[w];if(x&&x.getKeysCount()){var y=u?0:x.getKeysCount()-1;var z=x.getKey(y);var B=e.interpolate(x.getKeysType(),z,z,0,x);k(q,w,B);}}});}};for(i=c.length-1;i>=g;i--){p=c[i].getPlaybacks();if(Array.isArray(p)){for(j=p.length-1;j>=0;j--){l(p[j].getSequence(),true);}}}for(i=0;i<g;i++){p=c[i].getPlaybacks();if(Array.isArray(p)){for(j=0;j<p.length;j++){l(p[j].getSequence(),false);}}}return h;};f.prototype.buildViewsInitialState=function(v,s){if(!Array.isArray(v)){return;}var c=function(n){var r=[];n.forEach(function(g,h){r.push(g);});return r;};v.forEach(function(g){var n=this._buildViewInitialState(g,v,s);if(n){g.updateNodeInfos(c(n));}},this);};return f;});
