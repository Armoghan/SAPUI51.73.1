/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./thirdparty/three","sap/base/Log","./BBoxSubdivider","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","./Thrustline","../View","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","./AnimationSequence","../AnimationPlayback","../RenderMode","./Material","../ObjectType"],function(q,t,L,B,U,T,O,P,D,A,a,V,b,C,c,d,f,g,h,j,k,m,n,o,R,M,p){"use strict";var S=function(e,i,l,a1){this._id=S._nextId++;S._add(this);this._callouts=new Map();this._cameras=new Map();this._images=new Map();this._imageIdsAndTileWidths=new Map();this._imageTextures=new Map();this._geometries=new Map();this._meshNodes=new Map();this._meshSubmeshes=new Map();this._geometryMeshes=new Map();this._materialMeshes=new Map();this._materialClones=new Map();if(e){this._rootNode=e;this._nodes=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._viewGroups=new Map();this._views=new Map();}else{this._rootNode=null;this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null;}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._sceneIdViewGroupMap=new Map();this._sceneIdViewMap=new Map();this._sceneIdJointMap=new Map();this._highlightStyles=new Map();this._animationHelper=new A(this);if(i){this._countentResource=i;var b1=i.getNodeProxy();var c1=b1.getNodeHierarchy();this._vkScene=c1.getScene();var d1=i.getSource();if(d1&&d1.name){this._sceneIdTreeNodesMap.set(d1.name,this._nodes);this._sceneIdRootNodeMap.set(d1.name,e);this._sceneIdViewGroupMap.set(d1.name,this._viewGroups);this._sceneIdViewMap.set(d1.name,this._views);this._sceneIdJointMap.set(d1.name,new Map());this._currentSceneId=d1.name;}if(this._rootNode){if(!this._rootNode.userData){this._rootNode.userData={};}this._rootNode.userData.skipIt=!i.name;}}this._viewThumbnails=new Map();this._thrustlines=new Map();this._animations=new Map();this._animationTracks=new Map();this._resolve=l;this._reject=a1;};S._nextId=1;S._map=new Map();S.prototype.getId=function(){return this._id;};S.getById=function(i){return this._map.get(i);};S._add=function(e){S._map.set(e.getId(),e);return this;};var r=[R.Default,R.Default,R.Default,R.LineIllustration,R.SolidOutline,R.ShadedIllustration];S.prototype.setScene=function(i){if(i.result!==1){this._reject(i.result);}else{var e=this._cameras.get(i.cameraId);this._resolve({node:this._parentNode,camera:e,backgroundTopColor:i.backgroundTopColor,backgroundBottomColor:i.backgroundBottomColor,contentResource:this._contentResource,builder:this});}};S.prototype.setRootNode=function(e,i,l,a1){this._rootNode=e;this._nodes=new Map();this._nodes.set(i,e);if(!this._rootNode.userData){this._rootNode.userData={};}this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._sequenceIdToPlaybacks=new Map();this._viewGroups=new Map();this._views=new Map();if(l){this._sceneIdTreeNodesMap.set(l,this._nodes);this._sceneIdRootNodeMap.set(l,e);this._sceneIdViewGroupMap.set(l,this._viewGroups);this._sceneIdViewMap.set(l,this._views);this._sceneIdJointMap.set(l,new Map());this._currentSceneId=l;}if(a1){this._vkScene=a1;}return this;};S.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var i=this._sceneIdTreeNodesMap.get(e);if(i){this._nodes=i;}else{this._nodes=null;}var l=this._sceneIdRootNodeMap.get(e);if(l){this._rootNode=l;}else{this._rootNode=null;}this._currentSceneId=e;}};S.prototype.getNode=function(e,i){if(i){this._resetCurrentScene(i);if(this._nodes){return this._nodes.get(e);}}else{var l=this._sceneIdTreeNodesMap.values();var a1=l.next();while(!a1.done){var b1=a1.value.get(e);if(b1){return b1;}a1=l.next();}}return null;};S.prototype.hasMesh=function(e){return this._meshSubmeshes.has(e);};S.prototype.hasImage=function(i){return this._images.has(i);};S.prototype.setNodePersistentId=function(e,i,l){if((e.userData.treeNode&&e.userData.treeNode.sid)||this.getNode(i,l)){return false;}this._resetCurrentScene(l);if(!e.userData.treeNode){e.userData.treeNode={};}e.userData.treeNode.sid=i;if(this._nodes){this._nodes.set(i,e);}return true;};var s=function(e){var i=new THREE.Matrix4();if(e.length===3){i.setPosition(new THREE.Vector3().fromArray(e));}else if(e.length===12){i.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0.0,0.0,0.0,1.0);}else if(e.length===16){i.set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]);}else{throw"Invalid matrix format";}return i;};var u={r:0.0235,g:0.0235,b:0.0235};var v={r:0.0602,g:0.0602,b:0.0602};S.prototype._createTemporaryMaterial=function(e){var i=new THREE.MeshPhongMaterial({color:0xaaaaaa});i.userData.defaultHighlightingEmissive=u;i.userData.defaultHighlightingSpecular=v;i.userData.materialUsed=0;i.userData.materialId=e;i.userData.toBeUpdated=true;var l=new M();l.setMaterialRef(i);this._vkScene.setMaterial(e,l);return i;};S.prototype._getMaterialRef=function(e){var i=this._vkScene.getMaterial(e);return i?i.getMaterialRef():null;};S.prototype.checkMaterialExists=function(e){if(this._getMaterialRef(e)===null){this._createTemporaryMaterial(e);return false;}return true;};S.prototype._attachMaterialClone=function(e,i){T.pushElementIntoMapArray(this._materialClones,e,i);};S.prototype._addDynamicObject=function(e,i){if(!this._rootNode.userData._vkDynamicObjects){this._rootNode.userData._vkDynamicObjects=[];}this._rootNode.userData._vkDynamicObjects.push(e);e._vkUpdate=i;};S.prototype.createNode=function(e,i){this._resetCurrentScene(i);var l=new THREE.Group();this._nodes.set(e.sid,l);var a1=this._nodes.get(e.parentId);(a1||this._rootNode).add(l);var b1=l.userData;b1.treeNode=e;if(e.closed){b1.closed=true;}if(e.selectable===false){b1.selectable=false;}if(e.visualisable===false){b1.skipIt=true;}if(e.metadata){b1.metadata=e.metadata;}if(e.veids){b1.veids=e.veids;}if(e.name){l.name=e.name;}if(e.visible!==undefined){l.layers.mask=e.visible?(1|0):0;}if(a1&&a1.name&&l.name&&l.name===a1.name+" offset geometry"){l.layers=a1.layers;}else{var c1=a1;while(c1){if(c1.userData.closed){l.layers=c1.layers;break;}c1=c1.parent;}}if(i){var d1=a1;while(d1){if((d1.layers.mask&1)===0){l.layers.mask&=~1;break;}d1=d1.parent;}}if(e.renderOrder){l.renderOrder=e.renderOrder;}if(e.opacity!==undefined){b1.opacity=e.opacity;}if(e.transform){l.applyMatrix(s(e.transform));}if(e.transformType){b1.transformType=e.transformType;switch(e.transformType){case"BILLBOARD_VIEW":this._addDynamicObject(l,b.prototype._billboardViewUpdate);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(l,b.prototype._lockToViewportUpdate);break;default:break;}}if(e.materialId){b1.materialId=e.materialId;}if(e.meshId){this.setMeshNode(e.sid,e.meshId);}if(l.parent.userData.objectType===p.Hotspot){b1.objectType=p.Hotspot;}else if(l.parent.userData.objectType===p.PMI){b1.objectType=p.PMI;}else if(e.contentType==="HOTSPOT"){b1.objectType=p.Hotspot;}else if(e.contentType==="PMI"){b1.objectType=p.PMI;}return l;};function w(e,i,l){var a1;if(e.isPolyline){var b1=new THREE.LineBasicMaterial({color:0xff0000,linewidth:1});if(i){b1.color.copy(i.color);}a1=new THREE.LineSegments(e,b1);}else{a1=new THREE.Mesh(e,i);}if(e.isPositionQuantized){z(a1,l.boundingBox);}U.increaseGeometryUsed(e);return a1;}S.prototype.getChildNodeIds=function(e,l,a1){this._resetCurrentScene(l);var b1=this._nodes.get(e);var c1=[];if(!b1){return c1;}if(b1&&b1.children){for(var i=0;i<b1.children.length;i++){var d1=b1.children[i];if(d1.userData.treeNode&&d1.userData.treeNode.sid){c1.push(d1.userData.treeNode.sid);}else if(a1&&d1.userData.submeshInfo&&d1.userData.submeshInfo.id){c1.push(d1.userData.submeshInfo.id);}}}return c1;};function x(l){for(var i=0;i<l.length;i++){if(l[i].type==="box"&&l[i].data){return l[i];}}return null;}function y(l){if(Array.isArray(l)){for(var i=0;i<l.length;i++){if(l[i].type===undefined||l[i].type==="mesh"||l[i].type==="line"){return l[i];}}}return null;}function z(e,i){if(i&&i.length===6){e.position.set((i[3]+i[0])*0.5,(i[4]+i[1])*0.5,(i[5]+i[2])*0.5);e.scale.set(Math.max(i[3]-i[0],Number.EPSILON),Math.max(i[4]-i[1],Number.EPSILON),Math.max(i[5]-i[2],Number.EPSILON));}}S.prototype.insertSubmesh=function(i){var l=this._getMaterialRef(i.materialId)||this._createTemporaryMaterial(i.materialId);var a1,b1;if(i.lods){var c1=y(i.lods);if(!c1){return false;}b1=this._geometries.get(c1.id);if(b1){a1=w(b1,l,c1);if(b1.userData&&b1.userData.noNormal&&i.materialId){this.updateMaterialForGeometryWithoutNormal(i.materialId);}}else{var d1;try{var e1=x(i.lods);if(e1&&e1.data){var f1=T.base64ToUint8Array(e1.data);var g1=B.unpackSubDividedBoundingBox(f1);d1=B.makeSubDividedBoundingBoxGeometry(g1);}}catch(e){}a1=new THREE.Mesh(d1?d1:new THREE.BoxBufferGeometry(1,1,1),l);var h1=c1.boundingBox;if(h1&&h1.length===6){var i1=new THREE.Matrix4();i1.scale(new THREE.Vector3(Math.max(h1[3]-h1[0],Number.EPSILON),Math.max(h1[4]-h1[1],Number.EPSILON),Math.max(h1[5]-h1[2],Number.EPSILON)));i1.setPosition(new THREE.Vector3((h1[3]+h1[0])*0.5,(h1[4]+h1[1])*0.5,(h1[5]+h1[2])*0.5));a1.geometry.applyMatrix(i1);}a1.userData.geometryId=c1.id;a1.userData.lodInfo=c1;T.pushElementIntoMapArray(this._geometryMeshes,c1.id,i.meshId);}}else{return false;}if(i.transform){a1.applyMatrix(s(i.transform));}a1.userData.submeshId=i.id;a1.userData.initialMaterialId=i.materialId;a1.userData.meshId=i.meshId;a1.userData.materialId=i.materialId;a1.userData.submeshInfo=i;T.pushElementIntoMapArray(this._materialMeshes,i.materialId,i.meshId);T.pushElementIntoMapArray(this._meshSubmeshes,i.meshId,a1);var j1=this._meshNodes.get(i.meshId);if(j1){j1.forEach(function(k1){var l1=a1.clone();l1.layers=k1.layers;if(k1.userData.materialId){l1.material=this._getMaterialRef(k1.userData.materialId)||a1.material;}k1.add(l1);G(k1,i.materialId,this._materialClones);}.bind(this));}return true;};function E(e,l,a1,b1){for(var i=0;i<e.length;i++){var c1=e[i];if(l&&c1.userData.geometryId===l&&c1.geometry!==a1){if(c1.type==="Mesh"&&!a1.isPolyline){c1.geometry=a1;if(a1.isPositionQuantized){z(c1,c1.userData.lodInfo.boundingBox);}U.increaseGeometryUsed(a1);}else{var d1=w(a1,c1.material,c1.userData.lodInfo);d1.userData=c1.userData;d1.layers=c1.layers;d1.parent=c1.parent;e[i]=d1;c1.parent=null;}}}}function F(e,i,l,a1){var b1=e.userData.opacity!==undefined?e.userData.opacity:1;var c1=e.children;c1.forEach(function(d1){if(d1.userData.materialId===i){U.increaseMaterialUsed(l);d1.material=l;d1.userData.opacity=b1;d1._vkUpdateMaterialOpacity();if(d1.material!==l){T.pushElementIntoMapArray(a1,i,d1.material);}}});}function G(e,i,l){var a1=e.userData.opacity!==undefined?e.userData.opacity:1;e.children.forEach(function(b1){if(b1.material&&(!i||i===b1.material.userData.materialId)){var c1=b1.material;b1.userData.opacity=a1;b1._vkUpdateMaterialOpacity();if(b1.material!==c1){T.pushElementIntoMapArray(l,b1.material.userData.materialId,b1.material);}}});}S.prototype.setGeometry=function(e){var i=new THREE.BufferGeometry();var l=new THREE.BufferAttribute(new Uint16Array(e.data.indices),1);var a1=new THREE.BufferAttribute(new Float32Array(e.data.points),3);i.setIndex(l);i.addAttribute("position",a1);if(!i.userData){i.userData={};}if(!e.isPolyline){if(e.data.normals&&e.data.normals.length===e.data.points.length){var b1=new THREE.BufferAttribute(new Float32Array(e.data.normals),3);i.addAttribute("normal",b1);}else{i.userData.noNormal=true;}if(e.data.uvs&&e.data.uvs.length*3===e.data.points.length*2){i.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(e.data.uvs),2));}}else{i.isPolyline=true;}i.computeBoundingBox();i.computeBoundingSphere();i.isPositionQuantized=e.isPositionQuantized;i.userData.geometryId=e.id;i.userData.geometryUsed=0;this._geometries.set(e.id,i);var c1=this._geometryMeshes.get(e.id);if(c1){for(var mi=0;mi<c1.length;mi++){var e1=c1[mi];var f1=this._meshNodes.get(e1);if(f1){for(var ni=0;ni<f1.length;ni++){E(f1[ni].children,e.id,i);}}var h1=this._meshSubmeshes.get(e1);if(h1){E(h1,e.id,i);}}}if(this._fireSceneUpdated){this._fireSceneUpdated();}return this;};S.prototype.setMeshNode=function(e,i){var l=this._nodes.get(e);if(l){T.pushElementIntoMapArray(this._meshNodes,i,l);var a1=this._meshSubmeshes.get(i);if(a1){a1.forEach(function(b1){var c1=b1.clone();c1.layers=l.layers;if(l.userData.materialId){c1.material=this._getMaterialRef(l.userData.materialId)||b1.material;}l.add(c1);}.bind(this));G(l,null,this._materialClones);}}};S.prototype.progress=function(e){L.log("reading progress:",e);};S.prototype.loadingFinished=function(i){if(this._fireLoadingFinished){this._fireLoadingFinished(i);}};S.prototype.getGeometry=function(e){return this._geometries.get(e);};var H=[f.RectangularShape,f.CircularShape,f.None,f.TextGlow];var I=[c.Viewport,c.Screen,c.World];var J=[g.None,g.Solid,g.Dash,g.Dot,g.DashDot,g.DashDotDot];var K=[j.None,j.Point,j.Arrow];var N=[d.PlainText,d.HtmlText];var Q=[h.Left,h.Center,h.Right];function W(e){var i=e.toString(16);if(e.length>=3){i=(((e[0]*255)<<16)|((e[1]*255)<<8)|(e[2]*255)).toString(16);}return"#"+"000000".substring(i.length)+i;}function X(e){for(var i=0,l=e.length;i<l;i++){if(!isFinite(e[i])){return false;}}return true;}S.prototype.createAnnotation=function(e,i){if(!X(e.position)){return;}this._resetCurrentScene(i);var l=this._nodes.get(e.nodeId);var a1=e.position;e.coordinateSpace|=0;var b1=e.backgroundOpacity;if(!b1){b1=e.backgroundColour?e.backgroundColour[3]:0;}var c1=e.borderOpacity;if(!c1){c1=e.borderColour?e.borderColour[3]:0;}var d1={node:l,coordinateSpace:I[e.coordinateSpace],style:H[e.shape||0],width:e.width,height:e.height,backgroundColor:e.backgroundColour?W(e.backgroundColour):"#fff",backgroundOpacity:b1,borderColor:e.borderColour?W(e.borderColour):"#000",borderOpacity:c1,borderWidth:e.borderWidth,borderLineStyle:J[e.borderLineStyle]};if(e.encoding!==undefined){d1.encoding=N[e.encoding];d1.font=e.font;d1.fontSize=e.fontSize;d1.fontWeight=Math.min(e.fontWeight,900);d1.fontItalic=e.fontItalic;d1.textColor=W(e.textColor);d1.link=e.link;d1.horizontalAlignment=Q[e.textHorizontalAlignment];d1.position=new THREE.Vector3().fromArray(a1);}else if(e.fontFace){d1.encoding=d.PlainText;d1.font=e.fontFace;d1.fontSize=Math.abs(e.fontSize);d1.fontWeight=Math.min(e.fontWeight,900);d1.textColor=W(e.textColour);}else{d1.encoding=d.HtmlText;}if(e.coordinateSpace<2){if(!d1.positions){d1.position=new THREE.Vector3(a1[0]*2-1,a1[1]*-2+1,a1[2]);}d1.renderOrder=(e.order|0)+1000;var e1=new b(d1);e1.setText(e.text);this._addDynamicObject(l,e1._update.bind(e1));}else{d1.anchorNode=this._nodes.get(e.sid)||this._rootNode;if(!d1.postion){d1.position=new THREE.Vector3().fromArray(a1);}d1.depthTest=false;d1.renderOrder=e.order|0;if(e.alwaysOnTop){d1.renderOrder=1;}var f1=new C(d1);f1.setText(e.text);this._callouts.set(e.id,f1);this._addDynamicObject(l,f1._update.bind(f1));}};S.prototype.createImageNote=function(e,i){this._resetCurrentScene(i);var l=this._nodes.get(e.nodeId);l.updateMatrix();var a1=new THREE.Vector3().fromArray(e.position);var b1=e.width;var c1=e.height;if(!e.properlyAligned){a1.x+=e.width*0.5;a1.y+=e.height*0.5;a1.applyMatrix4(l.matrix);b1=e.width*0.5*l.matrix.elements[0];c1=e.height*0.5*l.matrix.elements[5];}var d1=new b({node:l,coordinateSpace:c.Screen,renderOrder:(e.order|0)+1000,position:a1,width:b1,height:c1});var e1=this._getMaterialRef(e.labelMaterialId);d1.setMaterial(e1);this._addDynamicObject(l,d1._update.bind(d1));};S.prototype.insertLeaderLine=function(e,a1){this._resetCurrentScene(a1);var b1=this._callouts.get(e.annotationId);if(b1){var c1=[];for(var i=0,l=e.points.length;i<l;i++){c1.push(new THREE.Vector3().fromArray(e.points[i]));}var d1=this._getMaterialRef(e.materialId);var e1=this._nodes.get(e.startPointSid)||this._roteNode;b1.addLeaderLine(c1,e1,d1,K[e.startPointHeadStyle],K[e.endPointHeadStyle],e.pointHeadConstant,e.extensionLength);}};var Y=[k.DetailView,k.Cutaway];var Z=[m.Box,m.Circle,m.CircleLine,m.CirclePointer,m.CircleArrow,m.CircleBubbles,m.BoxLine,m.BoxNoOutline,m.SolidPointer,m.SolidArrow];S.prototype.createDetailView=function(i,e){this._resetCurrentScene(e);var l=this._nodes.get(i.nodeId);if(l){if(!i.properlyAligned){if(!i.shape){i.shape=i.leaderStyle?m.BoxLine:m.Box;}else{i.shape=[m.Circle,m.CircleLine,m.CirclePointer,m.CircleArrow,m.CircleBubbles][i.leaderStyle||0];}i.type=i.cutaway?k.Cutaway:k.DetailView;i.camera=i.camera?this.createCamera(i.camera):null;i.origin=new THREE.Vector2(l.position.x*2-1+l.scale.x,l.position.y*-2+1-l.scale.x);i.size=new THREE.Vector2(l.scale.x,l.scale.y);i.renderOrder=l.renderOrder;}else{i.type=Y[i.type];i.shape=Z[i.shape];i.camera=this._cameras.get(i.cameraId);i.origin=new THREE.Vector2().fromArray(i.origin);i.size=new THREE.Vector2().fromArray(i.size);}var a1=[];if(i.visibleNodes){i.visibleNodes.forEach(function(d1){var l=this._nodes.get(d1);if(l){a1.push(l);}else{L.warning("Unknown detailView visible node reference",d1);}}.bind(this));}var b1=[];if(i.targetNodes){i.targetNodes.forEach(function(d1){var l=this._nodes.get(d1);if(l){b1.push(l);}else{L.warning("Unknown detailView target node reference",d1);}}.bind(this));}var c1=new D({name:i.name,camera:i.camera,type:i.type,shape:i.shape,borderWidth:i.borderWidth||0,backgroundColor:W(i.backgroundColour),borderColor:W(i.borderColour),origin:i.origin,size:i.size,attachmentPoint:new THREE.Vector3().fromArray(i.attachment),metadata:i.metadata,veId:i.veid,visibleNodes:a1,targetNodes:b1});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[];}this._rootNode.userData._vkDetailViews.push({detailView:c1,node:l,renderOrder:i.renderOrder||0});}};S.prototype.insertThrustline=function(i){var e=this._nodes.get(i.thrustlineId);if(e&&!this._thrustlines.get(i.thrustlineId)){var l=new a({node:e,principleAxis:new THREE.Vector3().fromArray(i.principleAxis),material:this._getMaterialRef(i.materialId)});var a1=[];var b1=0;var c1=0;var d1=0;for(var ii=0;ii<i.itemCount;ii++){var f1={};f1.target=this._nodes.get(i.targets[ii]);f1.majorAxisIndex=i.itemMajorAxisesIndices[ii];var bi;f1.basisAxises=[];d1=b1+i.itemBasisAxisesCounts[ii];for(bi=b1;bi<d1;bi++){var h1={};h1.x=i.itemBasisAxisesCoordinates[bi*3];h1.y=i.itemBasisAxisesCoordinates[bi*3+1];h1.z=i.itemBasisAxisesCoordinates[bi*3+2];f1.basisAxises.push(h1);}b1=d1;f1.dimension={};f1.dimension.x=i.itemDimensionsCoordinates[ii*3];f1.dimension.y=i.itemDimensionsCoordinates[ii*3+1];f1.dimension.z=i.itemDimensionsCoordinates[ii*3+2];f1.center={};f1.center.x=i.itemCentersCoordinates[ii*3];f1.center.y=i.itemCentersCoordinates[ii*3+1];f1.center.z=i.itemCentersCoordinates[ii*3+2];f1.boundPoints=[];d1=c1+i.itemBoundPointsCounts[ii];for(bi=c1;bi<d1;bi++){var i1={};i1.x=i.itemBoundPointsCoordinates[bi*3];i1.y=i.itemBoundPointsCoordinates[bi*3+1];i1.z=i.itemBoundPointsCoordinates[bi*3+2];f1.boundPoints.push(i1);}c1=d1;a1.push(f1);}l.setItems(a1);var j1=0;var k1=[];for(var si=0;si<i.segmentCount;si++){var m1={};m1.startItemIndex=i.segmentsStartItemIndices[si];m1.endItemIndex=i.segmentsEndItemIndices[si];m1.startBoundIndex=i.segmentsStartBoundIndices[si];m1.endBoundIndex=i.segmentsEndBoundIndices[si];m1.ratios=[];d1=j1+i.segmentRatioCounts[si];for(var ri=0;ri<d1;ri++){var o1={};o1.x=i.segmentRatiosCoordinates[ri*2];o1.y=i.segmentRatiosCoordinates[ri*2+1];m1.ratios.push(o1);}j1=d1;k1.push(m1);}l.setSegments(k1);this._thrustlines.set(i.thrustlineId,l);this._addDynamicObject(e,l._update.bind(l));}};S.prototype._decrementResourceCounters=function(e){e.traverse(function(i){if(i.isMesh){U.decreaseMaterialUsed(i.material);U.decreaseGeometryUsed(i.geometry);}});};S.prototype.decrementResourceCountersForDeletedTreeNode=function(e,i){this._resetCurrentScene(i);var l=this;e=[].concat(e);e.forEach(function(id){var b1=l._nodes.get(id);if(b1){l._decrementResourceCounters(b1);l._nodes.delete(id);}});return this;};S.prototype.remove=function(e,l){this._resetCurrentScene(l);var a1=this;e=[].concat(e);e.forEach(function(id){var b1=a1._nodes.get(id);if(b1){a1._decrementResourceCounters(b1);if(b1.parent){b1.parent.remove(b1);}a1._nodes.delete(id);for(var i=0;i<b1.children.length;i++){var c1=b1.children[i];if(c1.userData&&c1.userData.treeNode&&c1.userData.treeNode.sid){a1.remove(c1.userData.treeNode.sid,l);}}}});return this;};S.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(i){var l=i.userData.geometryUsed;if(l<=0){i.dispose();}});return this;};S.prototype.createCamera=function(e,i){this._resetCurrentScene(i);var l;if(e.ortho){l=new THREE.OrthographicCamera(-1,1,1,-1,e.near,e.far);}else{l=new THREE.PerspectiveCamera(e.fov*180/Math.PI,1,e.near,e.far);}if(e.origin){var a1=new THREE.Vector3().fromArray(e.origin);l.position.copy(a1);}if(e.up){var up=new THREE.Vector3().fromArray(e.up);if(e.notUseDirectionVector){up.sub(l.position);}l.up.copy(up.normalize());}if(e.target){if(e.notUseDirectionVector){l.lookAt(new THREE.Vector3().fromArray(e.target));}else{l.lookAt((new THREE.Vector3().fromArray(e.target)).add(l.position));}}if(e.ortho){l.zoom=e.zoom||0.02;}this._rootNode.userData.camera=l;var c1=null;if(l.isOrthographicCamera){c1=new O();}else if(l.isPerspectiveCamera){c1=new P();}c1.setCameraRef(l);c1.setUsingDefaultClipPlanes(true);if(e.zoom===-1){c1.setZoomNeedRecalculate(true);}c1.cameraInfo=e;var d1=e.id;if(d1){this._cameras.set(d1,c1);}this._rootNode.userData.camera=c1;return c1;};S.prototype.insertCamera=function(e,i,l){this._resetCurrentScene(l);var a1=this._nodes.get(e);var b1=this._cameras.get(i);if(a1&&b1){(a1||this._rootNode).add(b1.parent?b1.clone():b1);}return this;};S.prototype.getCamera=function(e){return this._cameras.get(e);};S.prototype.updateMaterialForGeometryWithoutNormal=function(e){var i=this._getMaterialRef(e);if(i&&i.emissive){i.emissive.copy(i.color);i.side=THREE.DoubleSide;}return this;};S.prototype.createMaterial=function(e){var i=[];var l=e.id;var a1=this._getMaterialRef(l);if(e.lineWidth>0){if(!a1||!a1.isLineBasicMaterial){a1=new THREE.LineBasicMaterial();var b1=new M(true);b1.setMaterialRef(a1);this._vkScene.setMaterial(l,b1);}a1.color=new THREE.Color(e.lineColour[0],e.lineColour[1],e.lineColour[2]);a1.linewidth=e.lineWidth;a1.userData.lineStyle={width:e.lineWidth,haloWidth:e.lineHaloWidth||0,endCapStyle:e.lineEndRound?1:0,dashPattern:e.lineDashPattern||[],dashPatternScale:e.lineDashPatternScale,widthCoordinateSpace:e.lineWidthCoordinateSpace};a1.userData.materialInfo=e;a1.userData.materialId=l;return i;}if(!a1){a1=this._createTemporaryMaterial(l);}delete a1.userData.toBeUpdated;a1.userData.materialInfo=e;if(e.diffuseColour){a1.color.fromArray(e.diffuseColour);}if(e.specularColour){a1.specular.fromArray(e.specularColour);}var c1=true;if(e.emissiveColour){a1.emissive.fromArray(e.emissiveColour);if(a1.emissive.r!==0||a1.emissive.g!==0||a1.emissive.b!==0){c1=false;}}if(c1&&e.ambientColour){a1.emissive.fromArray(e.ambientColour);a1.emissive.multiplyScalar(0.2);}if(a1.opacity!==undefined){a1.opacity=e.opacity;a1.transparent=e.opacity<0.99;if(a1.transparent){a1.side=THREE.DoubleSide;}}var d1=a1.glossiness?a1.glossiness:0;var e1=a1.specularLevel?a1.specularLevel:0;a1.shininess=d1*2+e1*3;a1.userData.defaultHighlightingEmissive=u;a1.userData.defaultHighlightingSpecular=v;i=this.updateTextureMaps(l);if(i.length>0){a1.userData.imageIdsToLoad=new Set();for(var ti=0;ti<i.length;ti++){var g1=i[ti];T.pushElementIntoMapArray(this._imageTextures,g1.imageId,{textureType:g1.textureType,materialId:l});a1.userData.imageIdsToLoad.add(g1.imageId);}}var h1=this._materialMeshes.get(l);if(h1){for(var mi=0;mi<h1.length;mi++){var j1=h1[mi];var k1=this._meshNodes.get(j1);if(k1){for(var ni=0;ni<k1.length;ni++){F(k1[ni],l,a1,this._materialClones);}}}}return i;};S.prototype.getMaterial=function(e){return this._getMaterialRef(e);};var $=function(i){var l="";try{var a1=0x8000;var b1=0;var c1=i.length;var d1;while(b1<c1){d1=i.slice(b1,Math.min(b1+a1,c1));l+=String.fromCharCode.apply(null,d1);b1+=a1;}}catch(e){l="";}return l;};S.prototype.createImage=function(e){var l=new DataView(e.binaryData.buffer);var a1=true;if(l.getUint8(0,true)===parseInt("0xFF",16)&&l.getUint8(1,true)===parseInt("0xD8",16)){a1=false;}var b1=$(e.binaryData);var c1="data:image/"+(a1?"png":"jpeg")+";base64,"+btoa(b1);this._images.set(e.id,c1);var d1=this._imageTextures.get(e.id);if(d1){this._imageTextures.delete(e.id);for(var i=0;i<d1.length;i++){var e1=d1[i];this.updateTextureMap(e1.materialId,e1.textureType);}}return this;};var _=new THREE.TextureLoader();S.TextureType={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glosiness:9,AmbientOcclusion:10,Decal:11};S.prototype.updateTextureMaps=function(e){var i=[];var l=this._getMaterialRef(e);if(!l){return i;}var a1=l.userData.materialInfo;if(!a1){return i;}if(a1.textureDiffuse){var b1=this.updateTextureMap(e,S.TextureType.Diffuse);if(b1.imageId){i.push(b1);}}if(a1.textureBump){var c1=this.updateTextureMap(e,S.TextureType.Bump);if(c1.imageId){i.push(c1);}}if(a1.textureOpacity){var d1=this.updateTextureMap(e,S.TextureType.Opacity);if(d1.imageId){i.push(d1);}}if(a1.textureEmissive){var e1=this.updateTextureMap(e,S.TextureType.Emissive);if(e1.imageId){i.push(e1);}}if(a1.textureAmbientOcclusion){var f1=this.updateTextureMap(e,S.TextureType.AmbientOcclusion);if(f1.imageId){i.push(f1);}}if(a1.textureReflection){var g1=this.updateTextureMap(e,S.TextureType.Reflection);if(g1.imageId){i.push(g1);}}return i;};S.prototype.updateTextureMap=function(e,i){var l={textureType:i,imageId:null};var a1=this._getMaterialRef(e);if(!a1){return l;}var b1=a1.userData.materialInfo;if(!b1){return l;}var c1=null;switch(i){case S.TextureType.Diffuse:c1=b1.textureDiffuse;break;case S.TextureType.Bump:c1=b1.textureBump;break;case S.TextureType.Opacity:c1=b1.textureOpacity;break;case S.TextureType.Reflection:c1=b1.textureReflection;break;case S.TextureType.Emissive:c1=b1.textureEmissive;break;case S.TextureType.AmbientOcclusion:c1=b1.textureAmbientOcclusion;break;default:break;}if(!c1){return l;}var d1=c1[0];if(!d1){d1=c1;}var e1=this._images.get(d1.imageId);if(!e1){l.imageId=d1.imageId;return l;}var f1=_.load(e1,this._fireSceneUpdated);f1.wrapS=d1.uvHorizontalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;f1.wrapT=d1.uvVerticalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;f1.magFilter=d1.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;f1.minFilter=d1.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter;f1.anisotropy=4;var g1=d1.influence!==undefined?d1.influence:0;var h1=d1.uvHorizontalScale!==undefined?d1.uvHorizontalScale:1;var i1=d1.uvVerticalScale!==undefined?d1.uvVerticalScale:1;var j1=d1.uvHorizontalOffset!==undefined?d1.uvHorizontalOffset:0;var k1=d1.uvVerticalOffset!==undefined?d1.uvVerticalOffset:0;f1.repeat.set(h1,i1);f1.center.set(-j1,-k1);f1.offset.set(j1,k1);f1.rotation=-d1.uvRotationAngle;switch(i){case S.TextureType.Diffuse:a1.map=f1;a1.transparent|=e1.startsWith("data:image/png");break;case S.TextureType.Bump:a1.bumpMap=f1;a1.bumpScale=g1;break;case S.TextureType.Opacity:a1.alphaMap=f1;break;case S.TextureType.Reflection:f1.mapping=THREE.SphericalReflectionMapping;a1.envMap=f1;a1.combine=THREE.AddOperation;a1.reflectivity=g1;break;case S.TextureType.Emissive:a1.emissiveMap=f1;a1.emissive.setRGB(1,1,1);break;case S.TextureType.AmbientOcclusion:a1.aoMap=f1;break;default:}a1.userData.textureAdded=true;a1.needsUpdate=true;if(a1.userData.imageIdsToLoad){a1.userData.imageIdsToLoad.delete(d1.imageId);if(a1.userData.imageIdsToLoad.size===0){delete a1.userData.imageIdsToLoad;}}var l1=this._materialClones.get(e);if(l1){l1.forEach(function(m1){m1.copy(a1);m1.needsUpdate=true;});}return l;};S.prototype.insertPlayback=function(e,i,l){this._resetCurrentScene(l);var a1=this._vkScene.findSequence(e.sequenceId);var b1=new o(e.id,{sequence:a1,timeScale:e.speed?e.speed:1,preDelay:e.preDelay?e.preDelay:0,postDelay:e.postDelay?e.postDelay:0,repeats:e.repeat?Math.abs(e.repeat):0,reversed:e.reversed?true:false,startTime:e.start?e.start:0});var c1=this._views.get(i);if(c1){c1.addPlayback(b1);}if(!a1){T.pushElementIntoMapArray(this._sequenceIdToPlaybacks,e.sequenceId,b1);}return this;};S.prototype.insertSequence=function(i,e){var l;if(i.endTime){l=i.endTime;}else{l=1.0;}var a1=this._vkScene.createSequence(i.id,{name:i.name,duration:l});if(Array.isArray(i.joints)){var b1=this._sceneIdJointMap.get(e);i.joints.forEach(function(c1){var f1=b1.get(c1);if(f1){a1.setJoint(f1);}});}if(i.nodes&&i.nodes.length>0){for(var ni=0;ni<i.nodes.length;ni++){var d1=i.nodes[ni];T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,d1.trackId,{sequenceId:i.id,targetId:d1.sid,type:d1.binding,pivot:d1.pivot});}}var e1=this._sequenceIdToPlaybacks.get(i.id);if(e1){e1.forEach(function(c1){c1.setSequence(a1);});}return this;};S.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this;};S.prototype.insertJoints=function(e,l){this._resetCurrentScene(l);var a1=this._sceneIdJointMap.get(l);for(var i=0;i<e.length;i++){var b1=e[i];var c1=this._nodes.get(b1.childSid);var d1=this._nodes.get(b1.parentSid);if(c1&&d1){a1.set(b1.id,{node:c1,parent:d1,translation:b1.t?new THREE.Vector3().fromArray(b1.t):new THREE.Vector3(),quaternion:b1.q?new THREE.Quaternion().fromArray(b1.q):new THREE.Quaternion(),scale:b1.s?new THREE.Vector3(1,1,1).fromArray(b1.s):new THREE.Vector3(1,1,1)});}}return this;};S.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}e.userData.tracks=this._tracks;}return this;};S.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}}else{return this;}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map();}var i;var l=this._viewGroups.entries();var a1=l.next();while(!a1.done){i=a1.value[1];a1=l.next();var b1=[];for(var vi=0;vi<i.getViews().length;vi++){if(i.getViews()[vi].id){var d1=this._views.get(i.getViews()[vi].id);if(d1){b1.push(d1);}}}}return this;};S.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var i=this._viewGroups.entries();var l=i.next();while(!l.done){var a1=l.value[1];var b1=l.value[0];if(!a1||!a1.views||!a1.views.length){l=i.next();continue;}a1.removeViews();for(var vi=0;vi<a1.views.length;vi++){var d1=a1.views[vi].id;var e1=this._views.get(d1);if(e1&&e1.userData.viewInfo.thumbnailId&&!e1.thumbnailData){var f1=this._images.get(e1.userData.viewInfo.thumbnailId);if(f1){e1.thumbnailData=f1;}}if(e1){e1.viewGroupId=b1;a1.addView(e1);}}l=i.next();}return this;};S.prototype.insertViewGroup=function(i,e){this._resetCurrentScene(e);var l=this._viewGroups.get(i.id);if(!l){l=this._vkScene.createViewGroup({viewGroupId:i.id,name:i.name,description:i.description});this._viewGroups.set(i.id,l);}else{l.setViewGroupId(i.id);l.setName(i.name);l.setDescription(i.description);}l.type=i.type;l.metadata=i.metadata;l.veids=i.veids;l.views=i.views;l.sceneId=i.sceneId;return this;};S.prototype.getViewGroup=function(e,i){this._resetCurrentScene(i);var l=this._viewGroups.get(e);var a1=[];if(l&&l.views){for(var vi=0;vi<l.views.length;vi++){var c1=l.views[vi].id;var d1=this._views.get(c1);if(d1){a1.push(d1);}}}return a1;};S.prototype.insertView=function(e,i){this._resetCurrentScene(i);if(e.description){var l=new RegExp("^<[^>]*?>");if(l.test(e.description)){var a1=new RegExp("(^(<[^>]*?>\s*)+)|((<[^>]*?>\s*)+$)","g");var b1=e.description.replace(a1,"");if(!b1){e.description=b1;}}}var c1=this._vkScene.createView({viewId:e.viewId,name:e.name,description:e.description?"<pre style=\"white-space: pre-wrap;\">"+e.description+"</pre>":e.description});c1.userData={};c1.userData.viewInfo=e;if(e.thumbnailId){var d1=this._images.get(e.thumbnailId);if(d1){c1.thumbnailData=d1;}else{this._viewThumbnails.set(e.thumbnailId,c1);}}if(e.animatedThumbnailId){var e1=this._images.get(e.animatedThumbnailId);if(e1){c1.animatedThumbnailData=e1;c1.tileWidth=this._imageIdsAndTileWidths.get(e.animatedThumbnailId);}}if(e.cameraId){c1.camera=this._cameras.get(e.cameraId);}c1.type=e.type;c1.flyToTime=e.flyToTime;c1.preDelay=e.preDelay;c1.postDelay=e.postDelay;c1.navigationMode=e.navigationMode;c1.topColor=e.topColor;c1.bottomColor=e.bottomColor;c1.renderMode=r[e.renderMethod];c1.dimension=e.dimension;c1.query=e.query;c1.metadata=e.metadata;c1.veids=e.veids;c1.highlights=[];c1.viewGroupId=e.viewGroupId;c1.id=e.viewId;this._views.set(e.viewId,c1);if(c1.viewGroupId){var f1=this._viewGroups.get(c1.viewGroupId);if(f1){f1.addView(c1);}}return this;};S.prototype.setModelViewVisibilitySet=function(i){var e=this._views.get(i.viewId);var l=[];i.visibleNodes.forEach(function(a1){var b1=this._nodes.get(a1);if(b1){l.push({target:b1,visible:true});}else{L.warning("Unknown modelView visible node reference",a1);}}.bind(this));e.updateNodeInfos(l);};S.prototype.recordHighlightedNodeInView=function(e,i,l,a1){this._resetCurrentScene(a1);var b1=this._views.get(l);if(!b1){return this;}var c1=this._nodes.get(i);if(!c1){return this;}if(!b1.highlightIdNodesMap){b1.highlightIdNodesMap=new Map();}var d1=b1.highlightIdNodesMap.get(e);if(!d1){d1=[];}d1.push(c1);b1.highlightIdNodesMap.set(e,d1);return this;};S.prototype.insertHighlightStyle=function(i){var e=this._highlightStyles.get(i.id);if(e){return this;}e=i;if(i.duration===0){e.type="STATIC";}else if(i.duration>0&&i.cycles===0){e.type="INFINITE";}else{e.type="FINITE";}this._animationHelper.addAnimationTracksToHighlight(e);this._highlightStyles.set(i.id,e);return this;};S.prototype.insertModelViewHighlight=function(i){var e=this._views.get(i.viewId);if(e){var l=[];i.highlightNodes.forEach(function(d1){var e1=this._nodes.get(d1);if(e1){l.push(e1);}else{}}.bind(this));var a1={highlightNodes:l,color1:i.color1,color2:i.color2,opacity1:i.opacity1,opacity2:i.opacity2,duration:i.duration,cycles:i.cycles};if(i.duration===0){a1.type="STATIC";}else if(i.duration>0&&i.cycles===0){a1.type="INFINITE";}else{a1.type="FINITE";}var b1=new THREE.Color(i.color1).toArray();var c1=new THREE.Color(i.color2).toArray();b1[3]=((i.color1>>>24)&255)/255;c1[3]=((i.color2>>>24)&255)/255;a1.colours=[b1,c1];a1.opacities=[i.opacity1,i.opacity2];this._animationHelper.addAnimationTracksToHighlight(a1);e.highlights.push(a1);}};S.prototype.createThumbnail=function(i){var e=this._viewThumbnails.get(i.imageId);if(e){e.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,i.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:e});}}};S.prototype.highlightStyleExists=function(i){var e=this._highlightStyles.get(i);return e!==undefined;};S.prototype.finalizeHighlightsInViews=function(){return this;};S.prototype.getView=function(e,i){this._resetCurrentScene(i);return this._views.get(e);};S.prototype.getSequence=function(e){return this._vkScene.findSequence(e);};S.prototype.setViewCamera=function(e,i,l){this._resetCurrentScene(l);var a1=this._cameras.get(e);var b1=this._views.get(i);if(a1&&b1){b1.camera=a1;var c1=a1.getCameraRef();if(a1.cameraInfo&&c1){var d1=true;var e1=false;if(a1.cameraInfo.zoom===-1){e1=true;}var f1=new THREE.Vector3();c1.getWorldDirection(f1);if(c1.type==="PerspectiveCamera"){b1.setCameraInfo({type:c1.type,fov:a1.cameraInfo.fov*180/Math.PI,position:c1.position.toArray(),nearClipPlane:c1.near,farClipPlane:c1.far,upDirection:c1.up.toArray(),targetDirection:f1.toArray(),usingDefaultClipPlanes:d1});}if(c1.type==="OrthographicCamera"){b1.setCameraInfo({type:c1.type,zoomFactor:c1.zoom,position:c1.position.toArray(),nearClipPlane:c1.near,farClipPlane:c1.far,upDirection:c1.up.toArray(),targetDirection:f1.toArray(),usingDefaultClipPlanes:d1,zoomNeedRecalculate:e1});}}}return this;};S.prototype.setViewNodeInfos=function(e,i,l){this._resetCurrentScene(l);var a1=this._views.get(i);a1.setNodeInfos(e);return this;};S.prototype.setViewThumbnail=function(i,e,l,a1){this._resetCurrentScene(l);var b1=this._views.get(e);var c1=this._images.get(i);if(b1&&c1){if(b1.userData!==undefined){if(b1.userData.viewInfo.thumbnailId===i){b1.thumbnailData=c1;}else if(b1.userData.viewInfo.animatedThumbnailId===i){b1.animatedThumbnailData=c1;b1.tileWidth=a1;}}}return this;};S.prototype.cleanup=function(){this._rootNode=null;if(this._vkScene){this._vkScene.clearMaterials();}this._callouts.clear();this._cameras.clear();this._images.clear();this._imageIdsAndTileWidths.clear();this._imageTextures.clear();this._geometries.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._geometryMeshes.clear();this._materialMeshes.clear();this._materialClones.clear();this._currentSceneId=null;if(this._nodes){this._nodes.clear();}if(this._tracks){this._tracks.clear();}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear();}if(this._viewGroups){this._viewGroups.clear();}if(this._views){this._views.clear();}this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._sceneIdViewGroupMap.clear();this._sceneIdViewMap.clear();this._sceneIdJointMap.clear();this._highlightStyles.clear();S._map.delete(this._id);};S.prototype.insertAnimationGroup=function(i){var e=this._vkScene.findSequence(i.animationGroupRef.toString());if(!e){var l;if(i.endTime){if(!i.startTime){i.startTime=0;}l=i.endTime-i.startTime;}e=this._vkScene.createSequence(i.animationGroupRef.toString(),{name:i.name,duration:l});if(!e.userData){e.userData={};}e.userData.animations=[];}if(i.modelViewRef){var a1=this._views.get(i.modelViewRef);if(a1){var b1=this._vkScene.findSequence(i.animationGroupRef.toString());var c1=new o({sequence:b1,timeScale:i.playbackSpeed?i.playbackSpeed:1,preDelay:i.playbackPreDelay?i.playbackPreDelay:0,postDelay:i.playbackPostDelay?i.playbackPostDelay:0,repeat:i.playbackRepeat?Math.abs(i.playbackRepeat):0,reversed:i.playbackReversed?true:false,startTime:0});a1.addPlayback(c1);}}};S.prototype.insertAnimation=function(i){var e=this._animations.get(i.animationRef);if(!e){e={};e.type=i.animationType;e.targetRefs=[];e.targetPivots=[];e.sequenceId=i.animationGroupRef.toString();e.animationTracks=new Set();this._animations.set(i.animationRef,e);}if(i.animationGroupRef){var l=this._vkScene.findSequence(i.animationGroupRef.toString());if(!l.userData.animations.includes(i.animationRef)){l.userData.animations.push(i.animationRef);}}};S.prototype.insertAnimationTarget=function(i){var e=this._animations.get(i.animationRef);if(e){if(!e.targetRefs.includes(i.targetRef)){e.targetRefs.push(i.targetRef);e.targetPivots.push({x:i.targetPivotX,y:i.targetPivotY,z:i.targetPivotZ});}}};S.prototype.insertAnimationTrack=function(i){var e=this._animationTracks.get(i.animationTrackRef);var l=i.animationRef;if(!e){delete i.animationRef;e=i;this._animationTracks.set(i.animationTrackRef,e);}if(!l){return;}var a1=this._animations.get(l);if(!a1||!a1.sequenceId){return;}if(a1.animationTracks.has(e.animationTrackRef)){return;}else{a1.animationTracks.add(e.animationTrackRef);}var b1=this._vkScene.findSequence(a1.sequenceId);if(!b1){return;}if(!b1.userData){b1.userData={};}if(!b1.userData.tracks){b1.userData.tracks=[];}for(var ti=0;a1.targetRefs&&ti<a1.targetRefs.length;ti++){var d1=a1.targetRefs[ti];var e1=a1.targetPivots[ti];var f1=this._nodes.get(d1);if(!f1){continue;}var g1;if(e1.x!==0||e1.y!==0||e1.z!==0){g1=[e1.x,e1.y,e1.z];}var h1=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][e.type]||"";T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,i.animationTrackRef,{sequenceId:a1.sequenceId,targetId:d1,type:h1,pivot:g1});var i1={};i1.times=Array.prototype.slice.call(e.times);i1.values=Array.prototype.slice.call(e.values);i1.id=i.animationTrackRef;i1.cyclicInfo={};i1.cyclicInfo.cyclicStart=e.cyclicStart;i1.cyclicInfo.cyclicEnd=e.cyclicEnd;var ki;if(a1.type===0){if(e.dataType===0){if(e.values.length!==e.keyCount||e.times.length!==e.keyCount){continue;}if(e.type===3){i1.values=[];for(ki=0;ki<e.keyCount;ki++){i1.values.push(e.values[ki]);i1.values.push(e.values[ki]);i1.values.push(e.values[ki]);}}}else if(e.dataType===1||e.dataType===3){if(e.values.length!==3*e.keyCount||e.times.length!==e.keyCount){continue;}}else if(e.dataType===4||e.dataType===5||e.dataType===6){if(e.values.length!==4*e.keyCount||e.times.length!==e.keyCount){continue;}if(e.dataType===4){i1.rotateType="angleAxis";}else if(e.dataType===6){i1.rotateType="euler";}else{i1.rotateType="quaternion";for(var vi=3;vi<i1.values.length;vi=vi+4){i1.values[vi]=-i1.values[vi];}}}}b1.userData.tracks.push(i1);}};S.prototype.setAnimationTracks=function(e){var i=this._animations.get(e);if(!i||!i.sequenceId){return;}var l=this._vkScene.findSequence(i.sequenceId);if(l){if(l.userData&&l.userData.tracks){this._animationHelper.insertTracks(l.userData.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);}}};S.prototype.setAnimationPlaybacks=function(i){var e=this._viewGroups.get(i.viewGroupId);for(var l=0;l<e.getViews().length;l++){var a1=e.getViews()[l];this._animationHelper.processHighlights(a1,a1.id,this._vkScene);}this._animationHelper.setInitialNodePositionsFromSubsequentViews(e.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(e.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(e.getViews(),this._vkScene);this._animationHelper.setPlaybackStartTimes(e.getViews(),this._vkScene);this._animationHelper.buildViewsInitialState(e.getViews(),this._vkScene);};return S;});
