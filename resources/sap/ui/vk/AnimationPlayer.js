/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","./Core","./AnimationMath","./AnimationTrackType","./AnimationTrackValueType"],function(E,v,A,a,b){"use strict";var c=E.extend("sap.ui.vk.AnimationPlayer",{metadata:{associations:{viewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false}},events:{timeChanged:{time:{type:"float"},currentPlayback:{type:"sap.ui.vk.AnimationPlayback"}},stateChanged:{playing:{type:"boolean"},stopped:{type:"boolean"},endOfAnimation:{type:"boolean"}}}}});c.prototype._getViewStateManager=function(){var d=this.getViewStateManager();return d?sap.ui.getCore().byId(d):undefined;};c.prototype.init=function(){this._step=this._step.bind(this);this._playbackCollection=null;this._currentPlayback=null;this._time=0;v.getEventBus().subscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);};c.prototype.exit=function(){this._playbackCollection=null;this._currentPlayback=null;v.getEventBus().unsubscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);};c.prototype._onViewApplied=function(d,e,f){if(f.source.getId()!=this.getViewStateManager()){return;}var g=f.view;var i=f.ignoreAnimationPosition;this.activateView(g,i);};c.prototype.setTime=function(t,p){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){this._currentPlayback=undefined;this._time=0;}else{if(p!=null){t=this._getAbsoluteTime(t,p);}var d=this._getViewStateManager();this._time=t;if(t>=0&&t<=this.getTotalDuration()){var e=this._currentPlayback;this._currentPlayback=this._findPlaybackByAbsoluteTime(t);if(d&&this._currentPlayback&&e!==this._currentPlayback){var s=this._currentPlayback.getSequence();if(s){d.setJoints(s.getJoint());}}else if(!this._currentPlayback||!this._currentPlayback.getSequence()){d.setJoints(undefined);}}else if(d){d.setJoints(undefined);}if(d){var f={nodeRefs:[],positions:[]};var o={nodeRefs:[],values:[]};var n=this._collectNodeChanges();n.forEach(function(g,h){var i=d.getTransformation(h);var m=false;if(g.translate){m=true;i.translation=g.translate;}if(g.rotate){m=true;i.quaternion=g.rotate;}if(g.scale){m=true;i.scale=g.scale;}if(m){f.nodeRefs.push(h);f.positions.push(i);}if(g.opacity){d.setOpacity(h,g.opacity);o.nodeRefs.push(h);o.values.push(g.opacity);}},this);d.setTransformation(f.nodeRefs,f.positions);d.setOpacity(o.nodeRefs,o.values);}}this.fireTimeChanged({time:this._time,currentPlayback:this._currentPlayback});return this;};c.prototype.getTime=function(){return this._time;};c.prototype.getCurrentPlayback=function(){return this._currentPlayback;};c.prototype.getCurrentPlaybackTime=function(){var t=this._time;var p=this._playbackCollection.getPlaybacks();if(!Array.isArray(p)||!this.getCurrentPlayback()){return-1;}var i=0;while(p[i]!=this.getCurrentPlayback()){t-=p[i].getDuration();i++;}return t;};c.prototype.getStartTime=function(p){if(!this._playbackCollection){return undefined;}if(typeof p==="number"){p=this._playbackCollection.getPlayback(p);}return p?p.getStartTime():undefined;};c.prototype.getTotalDuration=function(){if(!this._playbackCollection){return 0;}var t=0;this._playbackCollection.getPlaybacks().forEach(function(p){t+=p.getDuration();});return t;};c.prototype.shoudAnimateNextFrame=function(){return this.getTime()>=0&&this.getTime()<=this.getTotalDuration();};c.prototype._step=function(t){if(!this._lastFrameTimestamp){this._lastFrameTimestamp=t;}var p=t-this._lastFrameTimestamp;this._lastFrameTimestamp=t;this.setTime(this.getTime()+p/1000);if(this.shoudAnimateNextFrame()){this._frameId=window.requestAnimationFrame(this._step);}else{this.stop();}};c.prototype._interpolate=function(d,e,t){var q;if(!e.before&&!e.after){return undefined;}else if(!e.before){return undefined;}else if(!e.after){if(d===b.Euler){q=A.neutralEulerToGlMatrixQuat(e.before.value);return A.glMatrixQuatToNeutral(q);}else if(d===b.AngleAxis){q=A.neutralAngleAxisToGlMatrixQuat(e.before.value);return A.glMatrixQuatToNeutral(q);}else if(d===b.Quaternion){q=A.neutralQuatToGlMatrixQuat(e.before.value);return A.glMatrixQuatToNeutral(q);}return e.before.value;}var k=0;if(e.before.time!==e.after.time){k=(e.time-e.before.time)/(e.after.time-e.before.time);}return A.interpolate(d,e.before,e.after,k,t);};c.prototype._getKeyFramesBracket=function(t,d){var k=d.getKeysCount();var r={time:t,before:undefined,after:undefined};for(var i=0;i<k;i++){var e=d.getKey(i);if(e.time===t){r.before=r.after=e;}else if(e.time>t){r.before=(i===0?undefined:d.getKey(i-1));r.after=e;break;}}if(!r.before&&!r.after&&k>0){r.before=d.getKey(k-1);}if(k>1&&(!r.after||!r.before)&&(d.isCycleForward()||d.isCycleBackward())){var f=d.getKey(0).time;var g=d.getKey(k-1).time-f;var h=Math.floor((t-f)/g);var j=t-g*h;return this._getKeyFramesBracket(j,d);}return r;};c.prototype._collectSequenceNodeChanges=function(t,n,s,i){var d=s.getNodeAnimation();var e=function(f,p,g){if(!f||!p||!g){return;}var h=n.get(f);if(!h){h={};n.set(f,h);}h[p]=g;};d.forEach(function(f){var k;for(var g in a){var h=a[g];var j=f[h];if(j&&(!i||(i&&j.isInfinite()))){k=this._getKeyFramesBracket(t,j);var l=this._interpolate(j.getKeysType(),k,j);e(f.nodeRef,h,l);}}},this);};c.prototype._collectPlaybackNodeChanges=function(d,n,p){var s=p.getSequence();if(!s){return;}var t=d-p.getStartTime();if(t<0){return;}var e=s.getDuration()*p.getTimeScale()*p.getRepeats();var f=(t-p.getPreDelay())/p.getTimeScale();if(f>0&&f%p.getSequence().getDuration()===0){f=s.getDuration();}else{f=f%p.getSequence().getDuration();}f=p.getReversed()?p.getSequence().getDuration()-f:f;if(t<p.getPreDelay()){}else if(t>p.getPreDelay()+e){this._collectSequenceNodeChanges(f,n,p.getSequence(),true);}else{this._collectSequenceNodeChanges(f,n,p.getSequence(),false);}};c.prototype._collectNodeChanges=function(){var n=new Map();var p=this._playbackCollection.getPlaybacks();var d=this.getTime();for(var i=0;i<p.length;i++){if(p[i].getStartTime()>d){continue;}this._collectPlaybackNodeChanges(d,n,p[i]);}return n;};c.prototype.play=function(){this._lastFrameTimestamp=undefined;this._frameId=window.requestAnimationFrame(this._step);v.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:true,stopped:false,endOfAnimation:false});this.fireStateChanged({playing:true,stopped:false});return this;};c.prototype.stop=function(){if(this._frameId){window.cancelAnimationFrame(this._frameId);this._frameId=undefined;}this._lastFrameTimestamp=undefined;this.fireStateChanged({playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});v.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});return this;};c.prototype.activateView=function(d,p){this.stop();this._currentPlayback=undefined;if(!p){this._playbackCollection=d;}else{this._playbackCollection=undefined;}this.setTime(0);if(p){this._playbackCollection=d;}return this;};c.prototype._getAbsoluteTime=function(t,p){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return-1;}var d=this._playbackCollection.getPlaybacks();if(p<0||p>=d.length){return-1;}var e=this._playbackCollection.getPlayback(p);if(!e||e.getDuration()<t||t<0){return-1;}var f=t;var i=0;while(i<p){var g=d[i].getDuration();f+=g;i++;}return f;};c.prototype._findPlaybackByAbsoluteTime=function(t){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return undefined;}var p=this._playbackCollection.getPlaybacks();var i=0;while(i<p.length){var d=p[i].getDuration();if(t<d){return p[i];}i++;}return undefined;};return c;});
