/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base",'sap/base/util/merge','sap/base/util/deepEqual'],function(F,m,d){"use strict";var g=function(s,S,e){sap.ui.require([s],S,e);};var G=function(o,p,e){var M=p.modifier;var h=M.getSelector(o.id,p.appComponent);var i=M.bySelector(h,p.appComponent,p.view);if(!i&&e){i=e.find(function(j){var s;if(M.targets==="jsControlTree"){s=j.getFieldPath();}else{s=j.getAttribute("conditions");var E,S=s.indexOf("/conditions/");if(S>=0){s=s.slice(S+12);E=s.indexOf("}");if(E>=0){s=s.slice(0,E);}}}return s===o.name;});}return i;};var f=function(i){return i?"reverted ":"applied ";};var a=function(e){return e?"add filter ":"remove filter ";};var c=function(o,e,p,i){if(e.applyConditionsAfterChangesApplied){e.applyConditionsAfterChangesApplied();}return new Promise(function(h,j){var M=p.modifier;var k=i?o.getRevertData():o.getContent();var l=M.getAggregation(e,"filterItems");var I=k.index>-1?k.index:l.length;var n=G(k,p,l);var P=n?Promise.resolve(n):new Promise(function(h,j){var M=p.modifier;g(M.getProperty(e,"metadataDelegate"),function(q){q.beforeAddFilterFlex(k.name,e,p).then(function(n){if(n){h(n);}else{j();}});},j);});P.then(function(n){if(!n){j(new Error("No filter item created. Change to "+a(!i)+"cannot be "+f(i)+"at this moment"));return;}if(!M.findAggregation(n,"filterItems")){M.insertAggregation(e,"filterItems",n,I);}else{F.markAsNotApplicable("Specified change is already existing",true);}if(i){o.resetRevertData();}else{o.setRevertData({id:M.getId(n),name:k.name,index:I});}h();},function(){j(new Error("Change to "+a(!i)+"cannot be"+f(i)+"at this moment"));});});};var C=function(o,e,p,i){if(e.applyConditionsAfterChangesApplied){e.applyConditionsAfterChangesApplied();}return new Promise(function(h,j){var M=p.modifier,k=i?o.getRevertData():o.getContent();var l=G(k,p,M.getAggregation(e,"filterItems"));if(!l){if(i){j(new Error("No filter found. Change to "+a(i)+"cannot be "+f(i)+"at this moment"));return;}else{F.markAsNotApplicable("Specified change is already existing",true);}}var I=M.findIndexInParentAggregation(l);M.removeAggregation(e,"filterItems",l);if(i){o.resetRevertData();}else{o.setRevertData({id:M.getId(l),name:k.name,index:I});}g(M.getProperty(e,"metadataDelegate"),function(n){n.afterRemoveFilterFlex(l,e,p).then(function(q){if(q){M.destroy(l);}h();});},j);});};var b=function(o,e,p,i){if(e.applyConditionsAfterChangesApplied){e.applyConditionsAfterChangesApplied();}return new Promise(function(h,j){var M=p.modifier;var k=i?o.getRevertData():o.getContent();var l=G(k,p,M.getAggregation(e,"filterItems"));if(!l){j(new Error("No filter found. Change to move filter cannot be "+f(i)+"at this moment"));return;}var O=M.findIndexInParentAggregation(l);if(O!==k.index){M.removeAggregation(e,"filterItems",l);M.insertAggregation(e,"filterItems",l,k.index);}if(i){o.resetRevertData();}else{o.setRevertData({id:M.getId(l),name:k.name,index:O});}h();});};var A=function(o,e,h,p,i){if(h.applyConditionsAfterChangesApplied){h.applyConditionsAfterChangesApplied();}return new Promise(function(j){var k,l=null,M=p.modifier;k=m({},M.getProperty(h,"filtersConditions"));if(k){for(var s in k){if(s===e.name){l=k[s];break;}}}if(!l){k[e.name]=[];l=k[e.name];}var n=false;k[e.name].some(function(q){if(d(q.operator,e.condition.operator)&&d(q.values,e.condition.values)){n=true;}return n;});if(!n){l.push(e.condition);M.setProperty(h,"filtersConditions",k);if(!i){o.setRevertData({name:e.name,condition:e.condition});}}j();});};var r=function(o,e,h,p,i){if(h.applyConditionsAfterChangesApplied){h.applyConditionsAfterChangesApplied();}return new Promise(function(j){var k,l,n=-1,M=p.modifier;k=m({},M.getProperty(h,"filtersConditions"));if(k){for(var s in k){if(s===e.name){l=k[s];break;}}}if(l&&(l.length>0)){l.some(function(E,q){if(d(E.operator,e.condition.operator)&&d(E.values,e.condition.values)){n=q;}return n>=0;});if(n>=0){l.splice(n,1);M.setProperty(h,"filtersConditions",k);if(!i){o.setRevertData({name:e.name,condition:e.condition});}}}j();});};return{"addFilter":{"changeHandler":{applyChange:function(o,e,p){return c(o,e,p,false);},completeChangeContent:function(o,e,p){},revertChange:function(o,e,p){return C(o,e,p,true);}},"layers":{"USER":true}},"removeFilter":{"changeHandler":{applyChange:function(o,e,p){return C(o,e,p,false);},completeChangeContent:function(o,e,p){},revertChange:function(o,e,p){return c(o,e,p,true);}},"layers":{"USER":true}},"moveFilter":{"changeHandler":{applyChange:function(o,e,p){b(o,e,p,false);},completeChangeContent:function(o,e,p){},revertChange:function(o,e,p){b(o,e,p,true);}},"layers":{"USER":true}},"addCondition":{"changeHandler":{applyChange:function(o,e,p){return A(o,o.getContent(),e,p,false);},completeChangeContent:function(o,e,p){},revertChange:function(o,e,p){return r(o,o.getRevertData(),e,p,true).then(function(){o.resetRevertData();});}},"layers":{"USER":true}},"removeCondition":{"changeHandler":{applyChange:function(o,e,p){return r(o,o.getContent(),e,p,false);},completeChangeContent:function(o,e,p){},revertChange:function(o,e,p){return A(o,o.getRevertData(),e,p,true).then(function(){o.resetRevertData();});}},"layers":{"USER":true}}};},true);
