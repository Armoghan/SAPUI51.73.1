/*!
 * SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/XMLComposite","sap/ui/mdc/condition/Condition","sap/ui/model/Filter","sap/ui/base/ManagedObjectObserver","sap/m/FlexItemData","sap/base/util/merge","sap/ui/mdc/field/type/Boolean","sap/ui/mdc/field/type/String","sap/ui/mdc/condition/FilterOperatorUtil","sap/ui/mdc/Field"],function(X,C,F,M,a,m,N,U,b,c){"use strict";var D=X.extend("sap.ui.mdc.field.DefineConditionPanel",{metadata:{properties:{conditions:{type:"object[]",group:"Data",defaultValue:[],byValue:true},formatOptions:{type:"object",defaultValue:{}}},events:{}},fragment:"sap.ui.mdc.field.DefineConditionPanel",init:function(){sap.ui.getCore().getMessageManager().registerObject(this,true);this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["conditions","formatOptions"]});var v=this.byId("defineCondition");this._oObserver.observe(v,{aggregations:["content"]});},exit:function(){sap.ui.getCore().getMessageManager().unregisterObject(this,true);this._oObserver.disconnect();this._oObserver=undefined;if(this._oDefaultType){this._oDefaultType.destroy();delete this._oDefaultType;}},onBeforeRendering:function(){if(!this.oOperatorModel){var t=h.call(this);var o=g.call(this);var O=[];o.forEach(function(s){var i=b.getOperator(s);if(i.showInSuggest!==undefined&&i.showInSuggest==false){return;}var T=i.textKey||"operators."+i.name+".longText";var k=i.getTypeText(T,t.getName().toLowerCase());if(k===T){k=i.longText;}O.push({key:i.name,additionalText:k});},this);this.oOperatorModel=new sap.ui.model.json.JSONModel();this.oOperatorModel.setData(O);this.setModel(this.oOperatorModel,"om");}if(this.getConditions().length===0){this.updateDefineConditions();this._updateButtonVisibility();}},_updateButtonVisibility:function(o){var v=this.byId("defineCondition");if(!v){return;}var r=v.getContent();var k=this.getFormatOptions();var l=k.maxConditions;for(var i=0;i<r.length;i++){var R=r[i];var H=R.getContent()[2];var B=H.getItems()[1];B.setVisible((i===r.length-1)&&(l==-1||i<l-1));}},removeCondition:function(E){var s=E.oSource;var o=s.getBindingContext("$this").getObject();var i=C.indexOfCondition(o,this.getConditions());var k=this.getConditions();this._bUpdateConditionsInternal=true;k.splice(i,1);this.setProperty("conditions",k,true);this.updateDefineConditions();this._updateButtonVisibility();this.invalidate();},addCondition:function(E){var s=E.oSource;var o=s.getBindingContext("$this").getObject();var i=this.getConditions();var I=C.indexOfCondition(o,i);var k=this.getFormatOptions();var l=k.maxConditions;if(l==-1||i.length<l){this._bUpdateConditionsInternal=true;this.addDummyCondition(I+1);}},addDummyCondition:function(i){var o=g.call(this);var k=C.createCondition("EQ",[null]);b.checkConditionsEmpty(k,o);var l=this.getConditions();if(i!==undefined){l.splice(i,0,k);}else{l.push(k);}this.setProperty("conditions",l,true);this._updateButtonVisibility();},updateDefineConditions:function(){var i=this.getConditions().filter(function(o){return o.operator!=="EEQ";});if(i.length===0){this._bUpdateConditionsInternal=true;this.addDummyCondition();}},valueCtrlFactory:function(i,o){var k=o.oModel;var p=o.sPath;var l=parseInt(p.split("/")[p.split("/").length-1]);p=p.slice(0,p.lastIndexOf("/"));p=p.slice(0,p.lastIndexOf("/"));var n=k.getProperty(p);var O=g.call(this);var q=b.getOperator(n.operator,O);var r=h.call(this);var v=f.call(this,r,q,"$this>",l);v.addStyleClass("sapUiSmallPaddingBegin");v.setLayoutData(new a({shrinkFactor:0,growFactor:1}));if(v.attachChange){v.attachChange(this.onChange.bind(this));v.onpaste=this.onPaste.bind(this);}return v;},onChange:function(E){var o=g.call(this);var i=this.getConditions();b.checkConditionsEmpty(i,o);b.updateConditionsValues(i,o);this.setProperty("conditions",i,true);},onOperatorChange:function(E){var G=E.oSource.getParent();var i=G.getContent();var H=i[1];var l=H.getBinding("items");this.onChange(E);l.checkUpdate(true);},onPaste:function(E){var o,s=E.srcControl;if(window.clipboardData){o=window.clipboardData.getData("Text");}else{o=E.originalEvent.clipboardData.getData('text/plain');}var S=o.split(/\r\n|\r|\n/g);if(S&&S.length>1){setTimeout(function(){var O=g.call(this);var t=h.call(this);var T=j.call(this,t);var l=S.length;var k=this.getConditions();for(var i=0;i<l;i++){if(S[i]){var v=S[i];var V=v.split(/\t/g);var n;if(V.length==2&&V[0]&&V[1]){n=b.getOperator("BT",O);}else{V=[v.trim()];n=b.getDefaultOperator(T);}v=n?n.format(V):V[0];if(n){var p=n.getCondition(v,t);if(p){b.checkConditionsEmpty(p,O);k.push(p);}}}}this.setProperty("conditions",k,true);if(s.setDOMValue){s.setDOMValue("");}}.bind(this),0);}}});function _(o){if(o.name==="content"&&o.mutation==="insert"){d.call(this,o.child);}if(o.name==="formatOptions"){var i=this.getConditions();if(i.length>0){e.call(this);this.setConditions([]);this.setConditions(i);}}if(o.name==="conditions"){if(this._bUpdateConditionsInternal){this._bUpdateConditionsInternal=false;return;}if(this._sConditionsTimer){clearTimeout(this._sConditionsTimer);this._sConditionsTimer=null;}this._sConditionsTimer=setTimeout(function(){this._sConditionsTimer=null;this.updateDefineConditions();this._updateButtonVisibility();}.bind(this),0);}}function d(G){var i=G.getContent();var H=i[1];var l=H.getBinding("items");l.suspend();}function e(){var v=this.byId("defineCondition");var G=v.getContent();for(var i=0;i<G.length;i++){var o=G[i];var k=o.getContent();var H=k[1];var l=H.getBinding("items");l.resume();}}function f(o,O,p,i){if(O.valueTypes[i]&&O.valueTypes[i]!=="self"){o=O._createLocalType(O.valueTypes[i]);}if(O.createControl){return O.createControl(o,O,p,i);}var t=j.call(this,o);var n;switch(t){case"boolean":n=new N(o.oFormatOptions,o.oConstraints);break;case"numeric":if(o.oFormatOptions&&o.oFormatOptions.hasOwnProperty("emptyString")&&o.oFormatOptions.emptyString===null){n=o;}else{var T=sap.ui.require(o.getMetadata().getName().replace(/\./g,"/"));var k=m(o.oFormatOptions,{emptyString:null});n=new T(k,o.oConstraints);}break;case"date":case"time":case"datetime":n=o;break;default:break;}if(!n){n=new U(o.oFormatOptions,o.oConstraints);}var l=new c({value:{path:p,type:n,mode:'TwoWay',targetType:'raw'},width:"100%"});return l;}function g(){var o=this.getFormatOptions();var O=o&&o.operators;if(!O||O.lentrh===0){O=b.getOperatorsForType("string");}return O;}function h(){var o=this.getFormatOptions();var t=o&&o.valueType;if(!t){if(!this._oDefaultType){this._oDefaultType=new U();}t=this._oDefaultType;}return t;}function j(t){var T=t.getMetadata().getName();var o=t.oFormatOptions;var i=t.oConstraints;var k=this.getFormatOptions().delegate;var B=k?k.getBaseType(T,o,i):"string";if(B==="unit"){B="numeric";}return B;}return D;},true);
